<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imposter ‚Äî Online</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    html, body, #root { height: 100%; }
    .scroll-smooth { scroll-behavior: smooth; }
    .scrollbar-thin::-webkit-scrollbar { width: 5px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1a1a2e; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #4a4e69; border-radius: 20px; }
  </style>
</head>
<body class="antialiased bg-gradient-to-br from-gray-900 via-purple-900 to-violet-800 text-white">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, memo } = React;

    // --- CONFIG: Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAXVyAz8g5HJVSM-kra258NjXLdUEVu2ZI",
      authDomain: "imposter-9d3d4.firebaseapp.com",
      projectId: "imposter-9d3d4",
      databaseURL: "https://imposter-9d3d4-default-rtdb.europe-west1.firebasedatabase.app/",
      storageBucket: "imposter-9d3d4.appspot.com",
      messagingSenderId: "744643944793",
      appId: "1:744643944793:web:ef1a768eabaa2c580c2c48"
    };

    const isConfigSet = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL;

    if (isConfigSet) {
      firebase.initializeApp(firebaseConfig);
      var db = firebase.database();
    }

    const WORDS = {
      dyr: ['Elefant','Pingvin','Delfin','Tiger','Kenguru','Bj√∏rn','Rev','Ugle','Hai','Papeg√∏ye','Zebra','Giraff','Panda','Koala','Leopard'],
      ting: ['Piano','Paraply','Kompass','Teleskop','Koffert','Lommelykt','Mikrofon','Kamera','Sykkel','Skateboard','Trampoline','Fyrstikk','Hammer','Laptop']
    };

    function generateRoomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    function generateId(prefix = '') { return prefix + Math.random().toString(36).substring(2, 9); }

    const MemoizedGameScreen = memo(GameScreen);

    function App() {
      const [playerName, setPlayerName] = useState('');
      const [roomInput, setRoomInput] = useState('');
      const [roomCode, setRoomCode] = useState('');
      const [game, setGame] = useState(null);
      const [currentPlayer, setCurrentPlayer] = useState(null);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      
      const roomRef = useRef(null);

      useEffect(() => {
        if (!isConfigSet) return;
        const onUnload = () => leaveRoomCleanup();
        window.addEventListener('beforeunload', onUnload);
        return () => window.removeEventListener('beforeunload', onUnload);
      }, [roomCode, currentPlayer, game]);

      useEffect(() => {
        if (!isConfigSet || !roomCode) {
          if (roomRef.current) roomRef.current.off();
          setGame(null);
          return;
        }
        roomRef.current = db.ref('rooms/' + roomCode);
        roomRef.current.on('value', snapshot => {
          const val = snapshot.val();
          setGame(val || null);
          if (!val) {
             setError(`Rom "${roomCode}" finnes ikke lenger.`);
             setRoomCode('');
             setCurrentPlayer(null);
          }
        });
        return () => { if (roomRef.current) roomRef.current.off(); };
      }, [roomCode]);

      async function handleRoomAction(action) {
        setError('');
        const name = playerName.trim();
        const code = roomInput.trim().toUpperCase();
        if (!name) return setError('Skriv inn navnet ditt.');
        if (action === 'join' && !code) return setError('Skriv inn rom-koden.');
        if (!isConfigSet) return setError("Firebase-konfig mangler.");
        setLoading(true);

        try {
          let gameCode = action === 'create' ? await createNewRoom(name) : code;
          if (action === 'join') await joinExistingRoom(name, gameCode);
          setRoomCode(gameCode);
        } catch (err) {
          console.error(err);
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }

      async function createNewRoom(name) {
        let code = generateRoomCode();
        let tries = 0;
        while(tries < 5) {
            const snap = await db.ref('rooms/' + code).once('value');
            if (!snap.exists()) break;
            code = generateRoomCode();
            tries++;
        }
        if (tries >= 5) throw new Error("Klarte ikke √• lage unikt rom. Pr√∏v igjen.");

        const pid = generateId('p_');
        const player = { id: pid, name, score: 0, joinedAt: Date.now(), isHost: true };
        const gameObj = {
          code,
          phase: 'lobby',
          host: pid,
          players: { [pid]: player },
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        await db.ref('rooms/' + code).set(gameObj);
        setCurrentPlayer(player);
        return code;
      }

      async function joinExistingRoom(name, code) {
        const roomSnap = await db.ref('rooms/' + code).once('value');
        if (!roomSnap.exists()) throw new Error(`Rom "${code}" finnes ikke.`);
        
        const roomData = roomSnap.val();
        const names = Object.values(roomData.players || {}).map(p => p.name.toLowerCase());
        if (names.includes(name.toLowerCase())) throw new Error('Dette navnet er allerede i bruk.');

        const pid = generateId('p_');
        const player = { id: pid, name, score: 0, joinedAt: Date.now() };
        await db.ref(`rooms/${code}/players/${pid}`).set(player);
        setCurrentPlayer(player);
      }
      
      async function leaveRoomCleanup() {
        if (!game || !currentPlayer) return;
        const { code, players, imposter, host } = game;
        const pid = currentPlayer.id;

        await db.ref(`rooms/${code}/players/${pid}`).remove();

        const remainingPlayers = Object.keys(players || {}).filter(id => id !== pid);
        if (remainingPlayers.length === 0) {
          await db.ref(`rooms/${code}`).remove();
        } else {
            if(imposter === pid && game.phase !== 'lobby') {
                db.ref(`rooms/${code}`).update({
                    phase: 'lobby', word: null, category: null, imposter: null
                });
                await db.ref(`rooms/${code}/votes`).remove();
                await db.ref(`rooms/${code}/suspectId`).remove();
                await db.ref(`rooms/${code}/chat`).remove();
                await db.ref(`rooms/${code}/turn`).remove();
                await db.ref(`rooms/${code}/playerOrder`).remove();
            }
            if(host === pid) { 
                const newHostId = remainingPlayers.sort((a,b) => players[a].joinedAt - players[b].joinedAt)[0];
                db.ref(`rooms/${code}/host`).set(newHostId);
            }
        }
      }

      async function handleLeave() {
        await leaveRoomCleanup();
        setRoomCode('');
        setCurrentPlayer(null);
        setGame(null);
      }

      // --- UI rendering ---

      if (!isConfigSet) {
        return <div className="h-full flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl max-w-lg text-center shadow-lg">
            <h1 className="text-2xl font-bold mb-4">Firebase-konfig mangler</h1>
            <p className="text-gray-300 mb-4">Lim inn Firebase-konfigen i toppen av <code>index.html</code>.</p>
          </div>
        </div>;
      }

      if (!roomCode || !currentPlayer || !game) {
        return <div className="h-full flex items-center justify-center p-4">
          <div className="max-w-md w-full bg-white/10 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
            <h1 className="text-5xl font-extrabold text-center mb-6">IMPOSTER</h1>
            {error && <div className="mb-4 p-3 rounded-lg bg-red-500/50 text-white text-center">{error}</div>}
            <input className="w-full p-4 mb-4 bg-black/20 border border-white/20 rounded-lg placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ditt navn" value={playerName} onChange={e => setPlayerName(e.target.value)} />
            <button className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg mb-4 transition duration-300 disabled:opacity-50" onClick={() => handleRoomAction('create')} disabled={loading}>{loading ? 'Lager...' : 'Lag nytt rom'}</button>
            <div className="text-center text-gray-400 my-2">eller</div>
            <div className="flex gap-3">
              <input className="flex-grow p-4 bg-black/20 border border-white/20 rounded-lg placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Rom-kode" value={roomInput} onChange={e => setRoomInput(e.target.value)} />
              <button className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-6 rounded-lg transition duration-300 disabled:opacity-50" onClick={() => handleRoomAction('join')} disabled={loading}>{loading ? '...' : 'Bli med'}</button>
            </div>
          </div>
        </div>;
      }
      
      return <MemoizedGameScreen game={game} currentPlayer={currentPlayer} onLeave={handleLeave} />
    }

    function GameScreen({ game, currentPlayer, onLeave }) {
      const [chatInput, setChatInput] = useState('');
      const chatEndRef = useRef(null);

      useEffect(() => {
        if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
      }, [game?.chat?.messages]);

      async function startGame() {
        try {
          if (!game) return;
          const playersArr = Object.values(game.players || {});
          if (playersArr.length < 3) return;

          const category = Math.random() > 0.5 ? 'dyr' : 'ting';
          const word = WORDS[category][Math.floor(Math.random() * WORDS[category].length)];
          const imposter = playersArr[Math.floor(Math.random() * playersArr.length)].id;
          const playerOrder = playersArr.map(p => p.id).sort(() => Math.random() - 0.5); 

          const roomRef = db.ref(`rooms/${game.code}`);
          await roomRef.update({ phase: 'showWord', category, word, imposter, turn: 0, playerOrder });
          await roomRef.child('votes').remove();
          await roomRef.child('suspectId').remove();
          await roomRef.child('chat').remove();

          setTimeout(() => roomRef.child('phase').set('discussion'), 8000);
        } catch (err) {
          console.error("StartGame error:", err);
          alert(err.message);
        }
      }

      async function sendChatMessage(e) {
        e.preventDefault();
        if (!chatInput.trim() || !game || currentPlayer.id !== game.playerOrder[game.turn]) return;
        
        const message = {
          senderId: currentPlayer.id,
          senderName: currentPlayer.name,
          text: chatInput.trim(),
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        const newMsgRef = db.ref(`rooms/${game.code}/chat/messages`).push();
        await newMsgRef.set(message);

        const nextTurn = (game.turn + 1) % game.playerOrder.length;
        await db.ref(`rooms/${game.code}/turn`).set(nextTurn);
        setChatInput('');
      }

      async function castVote(votedForId) {
        if (!game || !currentPlayer || game.votes?.[currentPlayer.id]) return;
        await db.ref(`rooms/${game.code}/votes/${currentPlayer.id}`).set(votedForId);
        
        const pSnap = await db.ref(`rooms/${game.code}/players`).once('value');
        const vSnap = await db.ref(`rooms/${game.code}/votes`).once('value');
        const numPlayers = pSnap.exists() ? Object.keys(pSnap.val()).length : 0;
        const numVotes = vSnap.exists() ? Object.keys(vSnap.val()).length : 0;

        if (numVotes >= numPlayers) showResults(vSnap.val());
      }

      async function showResults(votesObj) {
        const votes = votesObj || {};
        const counts = {};
        Object.values(votes).forEach(id => { counts[id] = (counts[id] || 0) + 1; });
        
        let max = -1, suspectId = null;
        Object.entries(counts).forEach(([id, c]) => {
            if (c > max || (c === max && id < suspectId)) { max = c; suspectId = id; }
        });

        const players = { ...game.players };
        const imposterWasFound = suspectId === game.imposter;
        Object.keys(players).forEach(pid => {
          if (imposterWasFound && pid !== game.imposter) players[pid].score += 1;
          else if (!imposterWasFound && pid === game.imposter) players[pid].score += 2;
        });

        await db.ref(`rooms/${game.code}`).update({ phase: 'results', suspectId, players });
      }

      async function playAgain() {
        if (!game) return;
        const roomRef = db.ref(`rooms/${game.code}`);
        await roomRef.update({ phase: 'lobby', word: null, category: null, imposter: null });
        await roomRef.child('votes').remove();
        await roomRef.child('suspectId').remove();
        await roomRef.child('chat').remove();
        await roomRef.child('turn').remove();
        await roomRef.child('playerOrder').remove();
      }

      const playersArr = Object.values(game.players || {});
      const isImposter = currentPlayer.id === game.imposter;
      const me = game.players[currentPlayer.id];
      const isHost = currentPlayer.id === game.host;

      const MainContent = () => {
        switch(game.phase) {
          case 'lobby':
            return <>
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h2 className="text-2xl font-bold">Lobby</h2>
                  <p className="text-gray-400">Venter p√• at spillere skal bli med...</p>
                </div>
                {isHost && <button className={`bg-green-500 text-white font-bold py-3 px-6 rounded-lg transition ${playersArr.length < 3 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600'}`} disabled={playersArr.length < 3} onClick={startGame}>Start Spillet</button>}
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {playersArr.map(p => <div key={p.id} className="bg-white/10 p-4 rounded-xl text-center"><div className="font-bold text-lg">{p.name} {game.host === p.id && 'üëë'}</div><div className="text-sm text-purple-300">Poeng: {p.score || 0}</div></div>)}
              </div>
            </>;
          
          case 'showWord':
            return <div className="text-center py-10">
              <h2 className="text-3xl font-bold mb-4">{isImposter ? 'Du er Imposter!' : 'Ditt hemmelige ord er:'}</h2>
              {isImposter ? 
                <div className="inline-block bg-red-500/80 px-10 py-8 rounded-2xl text-2xl font-bold shadow-lg">V√¶r lur, blend inn!</div> :
                <div className="inline-block bg-blue-500/80 px-10 py-8 rounded-2xl text-4xl font-bold shadow-lg">{game.word}</div>
              }
              <p className="text-gray-300 mt-5 text-lg">Kategori: <span className="font-semibold">{game.category === 'dyr' ? 'üêæ Dyr' : 'üîß Ting'}</span></p>
              <p className="mt-8 text-gray-400">Diskusjonen starter om noen sekunder...</p>
            </div>;
          
          case 'discussion':
            const currentTurnPlayer = game.players[game.playerOrder[game.turn]];
            const sortedMessages = Object.entries(game.chat?.messages || {}).sort(([,a],[,b]) => a.timestamp - b.timestamp);
            return <div className="flex flex-col h-full">
              <div className="flex-1 overflow-y-auto scrollbar-thin mb-3">
                <div className="space-y-2">
                  {sortedMessages.map(([id,msg]) => (
                    <div key={id} className={`p-2 rounded-lg ${msg.senderId === currentPlayer.id ? 'bg-purple-600/60 text-right' : 'bg-white/10 text-left'}`}>
                      <span className="font-semibold">{msg.senderName}:</span> {msg.text}
                    </div>
                  ))}
                  <div ref={chatEndRef}></div>
                </div>
              </div>
              {currentTurnPlayer?.id === currentPlayer.id ? (
                <form onSubmit={sendChatMessage} className="flex gap-2">
                  <input value={chatInput} onChange={e => setChatInput(e.target.value)} placeholder="Si noe..." className="flex-grow p-3 rounded-lg bg-black/30 border border-white/20 focus:ring-2 focus:ring-purple-400 outline-none" />
                  <button className="bg-purple-600 hover:bg-purple-700 px-5 rounded-lg">Send</button>
                </form>
              ) : (
                <div className="text-center text-gray-400 py-3">
                  {currentTurnPlayer ? `Venter p√• ${currentTurnPlayer.name}...` : 'Vent litt...'}
                </div>
              )}
              {isHost && <button onClick={() => db.ref(`rooms/${game.code}/phase`).set('voting')} className="mt-3 bg-pink-600 hover:bg-pink-700 px-6 py-3 rounded-lg w-full font-bold">Start Avstemning</button>}
            </div>;
          
          case 'voting':
            return <div className="text-center">
              <h2 className="text-3xl font-bold mb-4">Hvem er Imposter?</h2>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                {playersArr.map(p => (
                  <button key={p.id} onClick={() => castVote(p.id)} className={`p-4 rounded-xl transition ${game.votes?.[currentPlayer.id] === p.id ? 'bg-purple-700' : 'bg-white/10 hover:bg-white/20'}`}>{p.name}</button>
                ))}
              </div>
              <p className="mt-4 text-gray-400">{Object.keys(game.votes || {}).length}/{playersArr.length} har stemt</p>
            </div>;
          
          case 'results':
            const suspect = game.players[game.suspectId];
            return <div className="text-center py-10">
              <h2 className="text-3xl font-bold mb-4">Resultat</h2>
              <p className="text-xl mb-2">Mistenkt: <span className="font-bold text-purple-300">{suspect?.name || '?'}</span></p>
              <p className="text-xl mb-6">Imposter var: <span className="font-bold text-red-400">{game.players[game.imposter]?.name}</span></p>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                {playersArr.map(p => <div key={p.id} className="bg-white/10 p-4 rounded-xl"><div className="font-bold">{p.name}</div><div>Poeng: {p.score}</div></div>)}
              </div>
              {isHost && <button onClick={playAgain} className="bg-green-600 hover:bg-green-700 px-8 py-4 rounded-lg text-xl font-bold">Spill Igjen</button>}
            </div>;
        }
      };

      return <div className="h-full flex flex-col">
        <div className="p-4 bg-black/30 flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-bold">Rom: {game.code}</h1>
            <p className="text-gray-400 text-sm">{currentPlayer.name}{isHost && ' (Vert)'}</p>
          </div>
          <button onClick={onLeave} className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">Forlat Rom</button>
        </div>
        <div className="flex-1 overflow-y-auto p-6"><MainContent /></div>
      </div>;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
