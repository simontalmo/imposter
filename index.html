<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imposter ‚Äî online</title>

  <!-- Tailwind for enkel styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM UMD (demo) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (transpile JSX i browser for demo) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>html,body,#root{height:100%}</style>
</head>
<body class="antialiased bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  // --- KONFIGURASJON: lim inn Firebase-konfigen din her ---
  // G√• til Firebase Console -> Project settings -> Your apps -> SDK snippet -> Config
  const firebaseConfig = {
    apiKey: "AIzaSyAXVyAz8g5HJVSM-kra258NjXLdUEVu2ZI",
    authDomain: "imposter-9d3d4.firebaseapp.com",
    projectId: "imposter-9d3d4",
    storageBucket: "imposter-9d3d4.firebasestorage.app",
    messagingSenderId: "744643944793",
    appId: "1:744643944793:web:ef1a768eabaa2c580c2c48",
    measurementId: "G-LXRXHVZR6B",
    databaseURL: "https://imposter-9d3d4-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  // --- F√∏rste gang: hvis config ikke er fylt ut, vis instruksjon i UI ---
  const isConfigSet = firebaseConfig && firebaseConfig.databaseURL && !firebaseConfig.apiKey.includes("PUT_YOUR");

  // init Firebase
  if (isConfigSet) {
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
  }

  // --- Ord-lister ---
  const WORDS = {
    dyr: ['Elefant','Pingvin','Delfin','Tiger','Kenguru','Bj√∏rn','Rev','Ugle','Hai','Papeg√∏ye','Zebra','Giraff','Panda','Koala','Leopard'],
    ting: ['Piano','Paraply','Kompass','Teleskop','Koffert','Lommelykt','Mikrofon','Kamera','Sykkel','Skateboard','Trampoline','Fyrstikk','Hammer','Laptop']
  };

  // --- Util ---
  function generateRoomCode() {
    return Math.random().toString(36).replace(/[^a-z0-9]+/g,'').substring(2,8).toUpperCase();
  }
  function generateId(prefix='') { return prefix + Math.random().toString(36).substring(2,9); }

  // --- App ---
  function App(){
    const [playerName, setPlayerName] = useState('');
    const [roomInput, setRoomInput] = useState('');
    const [roomCode, setRoomCode] = useState('');
    const [game, setGame] = useState(null);
    const [currentPlayer, setCurrentPlayer] = useState(null);
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const roomRef = useRef(null);

    useEffect(() => {
      if (!isConfigSet) return;
      // cleanup on unload: remove player if present
      const onUnload = () => {
        leaveRoomCleanup();
      };
      window.addEventListener('beforeunload', onUnload);
      return () => window.removeEventListener('beforeunload', onUnload);
    }, [roomCode, currentPlayer]);

    useEffect(() => {
      if (!isConfigSet) return;
      if (!roomCode) {
        // unsubscribe if any
        if (roomRef.current) {
          roomRef.current.off();
          roomRef.current = null;
        }
        setGame(null);
        return;
      }
      // set up realtime listener
      roomRef.current = db.ref('rooms/' + roomCode);
      roomRef.current.on('value', snapshot => {
        const val = snapshot.val();
        if (!val) {
          setGame(null);
        } else {
          setGame(val);
        }
      });
      // ensure we read immediately
      roomRef.current.once('value').then(snap => {
        if (!snap.exists()) {
          // no room yet
        } else {
          setGame(snap.val());
        }
      });
      return () => { if (roomRef.current) roomRef.current.off(); roomRef.current = null; };
    }, [roomCode]);

    // CREATE ROOM
    async function createRoom(){
      setError('');
      const name = playerName.trim();
      if (!name) return setError('Skriv inn navnet ditt.');
      setLoading(true);

      // pr√∏v √• finne unik kode
      let code = generateRoomCode();
      let tries = 0;
      while (tries < 6) {
        const snap = await db.ref('rooms/' + code).once('value');
        if (!snap.exists()) break;
        code = generateRoomCode();
        tries++;
      }

      // opprett spiller og game-objekt
      const pid = generateId('p_');
      const player = { id: pid, name, score: 0, joinedAt: Date.now() };
      const gameObj = {
        code,
        phase: 'lobby',
        players: { [pid]: player }, // lag som keys for enklere fjern/oppdater
        word: null,
        category: null,
        imposter: null,
        votes: {},
        suspectId: null,
        createdAt: Date.now()
      };

      await db.ref('rooms/' + code).set(gameObj);

      setRoomCode(code);
      setCurrentPlayer(player);
      setLoading(false);
    }

    // JOIN ROOM
    async function joinRoom(){
      setError('');
      const name = playerName.trim();
      const code = roomInput.trim().toUpperCase();
      if (!name) return setError('Skriv inn navnet ditt.');
      if (!code) return setError('Skriv inn rom-koden.');
      setLoading(true);

      const roomSnap = await db.ref('rooms/' + code).once('value');
      if (!roomSnap.exists()) {
        setError(`Rom "${code}" finnes ikke.`);
        setLoading(false);
        return;
      }
      const roomData = roomSnap.val();

      // ensure unique name within room
      const names = Object.values(roomData.players || {}).map(p => p.name.toLowerCase());
      if (names.includes(name.toLowerCase())) {
        setError('Dette navnet er allerede i bruk i rommet. Velg et annet.');
        setLoading(false);
        return;
      }

      const pid = generateId('p_');
      const player = { id: pid, name, score: 0, joinedAt: Date.now() };

      // push player atomically
      await db.ref(`rooms/${code}/players/${pid}`).set(player);

      setRoomCode(code);
      setCurrentPlayer(player);
      setLoading(false);
    }

    // START GAME (server-side-like atomic update)
    async function startGame(){
      if (!game) return;
      const playersObj = game.players || {};
      const playersArr = Object.values(playersObj);
      if (playersArr.length < 3) { setError('Trenger minst 3 spillere.'); return; }

      const category = Math.random() > 0.5 ? 'dyr' : 'ting';
      const word = WORDS[category][Math.floor(Math.random() * WORDS[category].length)];
      // choose imposter randomly
      const imposter = playersArr[Math.floor(Math.random() * playersArr.length)].id;

      // oppdater DB
      await db.ref(`rooms/${game.code}`).update({
        phase: 'showWord',
        category,
        word,
        imposter,
        votes: {},
        suspectId: null
      });

      // after delay -> set discussion
      setTimeout(async () => {
        const snap = await db.ref(`rooms/${game.code}`).once('value');
        if (!snap.exists()) return;
        await db.ref(`rooms/${game.code}`).update({ phase: 'discussion' });
      }, 8000);
    }

    // START VOTING
    async function startVoting(){
      if (!game) return;
      await db.ref(`rooms/${game.code}`).update({ phase: 'voting', votes: {} });
    }

    // CAST VOTE (transaction to ensure correctness)
    async function castVote(voterId, votedForId){
      if (!game) return;
      // write vote under votes/voterId
      await db.ref(`rooms/${game.code}/votes/${voterId}`).set(votedForId);

      // check if all have voted
      const snap = await db.ref(`rooms/${game.code}/onceValue`).catch(()=>null);
      // simpler: fetch players and votes
      const pSnap = await db.ref(`rooms/${game.code}/players`).once('value');
      const vSnap = await db.ref(`rooms/${game.code}/votes`).once('value');
      const numPlayers = pSnap.exists() ? Object.keys(pSnap.val()).length : 0;
      const numVotes = vSnap.exists() ? Object.keys(vSnap.val()).length : 0;
      if (numVotes >= numPlayers) {
        // compute results
        showResults(vSnap.val());
      }
    }

    // SHOW RESULTS (compute and write to DB)
    async function showResults(votesObj) {
      if (!game) return;
      const votes = votesObj || {};
      const counts = {};
      Object.values(votes).forEach(id => { counts[id] = (counts[id] || 0) + 1; });
      // find highest (tie-break deterministic by id)
      let max = -1, suspectId = null;
      Object.entries(counts).forEach(([id,c]) => {
        if (c > max || (c === max && id < suspectId)) { max = c; suspectId = id; }
      });

      // update scores
      const players = { ...(game.players || {}) };
      Object.keys(players).forEach(pid => {
        const p = players[pid];
        if (suspectId === game.imposter && pid !== game.imposter) {
          players[pid].score = (players[pid].score||0) + 1;
        } else if (suspectId !== game.imposter && pid === game.imposter) {
          players[pid].score = (players[pid].score||0) + 2;
        }
      });

      await db.ref(`rooms/${game.code}`).update({
        phase: 'results',
        suspectId: suspectId || null,
        players // overwrite players object (safe small room)
      });
    }

    // PLAY AGAIN (reset to lobby but keep players & scores)
    async function playAgain(){
      if (!game) return;
      await db.ref(`rooms/${game.code}`).update({
        phase: 'lobby',
        word: null,
        category: null,
        imposter: null,
        votes: {},
        suspectId: null
      });
    }

    // LEAVE ROOM (cleanup)
    async function leaveRoomCleanup(){
      if (!game || !currentPlayer) return;
      const pid = currentPlayer.id;
      const code = game.code;
      // remove player
      await db.ref(`rooms/${code}/players/${pid}`).remove();

      // check if remaining players -> if 0 remove room entirely
      const remSnap = await db.ref(`rooms/${code}/players`).once('value');
      if (!remSnap.exists()) {
        await db.ref(`rooms/${code}`).remove();
      } else {
        // if imposter was the leaving player, reset round to lobby for safety
        const gSnap = await db.ref(`rooms/${code}`).once('value');
        const g = gSnap.val();
        if (g && g.imposter === pid) {
          await db.ref(`rooms/${code}`).update({
            phase: 'lobby',
            word: null,
            category: null,
            imposter: null,
            votes: {},
            suspectId: null
          });
        }
      }
    }

    // UI rendering
    if (!isConfigSet) {
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg text-center">
            <h1 className="text-2xl font-bold mb-4">Firebase-konfig mangler</h1>
            <p className="text-gray-700 mb-4">Du m√• lime inn Firebase-konfigen i toppen av denne filen for at online-funksjonen skal fungere.</p>
            <p className="text-sm text-gray-500">1) Opprett Firebase-prosjekt ‚Üí 2) Aktiver Realtime Database ‚Üí 3) Kopier konfig og lim inn i firebaseConfig.</p>
          </div>
        </div>
      );
    }

    if (!roomCode) {
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="max-w-xl w-full bg-white rounded-3xl p-8 shadow-2xl">
            <h1 className="text-4xl font-extrabold text-center mb-2">IMPOSTER</h1>
            {error && <div className="mb-4 p-3 rounded bg-red-50 text-red-700">{error}</div>}
            <input className="w-full p-3 mb-3 border rounded" placeholder="Ditt navn" value={playerName} onChange={(e)=>setPlayerName(e.target.value)} />
            <div className="flex gap-3 mb-3">
              <button className="flex-1 bg-purple-600 text-white py-3 rounded" onClick={createRoom} disabled={loading}>{loading ? 'Lager...' : 'Lag nytt rom'}</button>
            </div>
            <div className="text-center text-sm text-gray-500 mb-3">eller</div>
            <input className="w-full p-3 mb-3 border rounded" placeholder="Rom-kode" value={roomInput} onChange={e=>setRoomInput(e.target.value)} />
            <button className="w-full bg-orange-500 text-white py-3 rounded" onClick={joinRoom} disabled={loading}>{loading ? 'Kobler...' : 'Bli med i rom'}</button>
            <div className="mt-4 text-sm text-gray-600">Husk: samme romkode gj√∏r at andre kan koble seg til og spille.</div>
          </div>
        </div>
      );
    }

    if (!game) {
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white p-8 rounded-xl shadow text-center max-w-md">
            <h2 className="text-xl font-bold mb-3">Rom ikke funnet</h2>
            <p className="text-gray-600 mb-4">Rommet ble ikke funnet eller er slettet.</p>
            <button className="bg-gray-100 px-4 py-2 rounded" onClick={() => { setRoomCode(''); setCurrentPlayer(null); }}>Tilbake</button>
          </div>
        </div>
      );
    }

    // helpers for rendering
    const playersArr = Object.values(game.players || {});
    const isImposter = currentPlayer && game.imposter === currentPlayer.id;
    const imposterPlayer = playersArr.find(p=>p.id === game.imposter);
    const suspectPlayer = playersArr.find(p=>p.id === game.suspectId);

    return (
      <div className="min-h-screen p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-3xl p-6 shadow-2xl">
            <div className="flex justify-between items-center mb-3">
              <div>
                <h1 className="text-2xl font-bold">IMPOSTER</h1>
                <div className="text-sm text-gray-600">Rom: <span className="font-mono font-bold">{game.code}</span></div>
              </div>
              <div className="flex items-center gap-3">
                <div className="text-sm">Du: <strong>{currentPlayer?.name}</strong></div>
                <button className="px-3 py-2 bg-gray-100 rounded" onClick={()=>navigator.clipboard.writeText(game.code)}>Kopier kode</button>
                <button className="px-3 py-2 bg-red-100 rounded text-red-700" onClick={async ()=>{ await leaveRoomCleanup(); setRoomCode(''); setCurrentPlayer(null); }}>Forlat</button>
              </div>
            </div>

            <hr className="my-4" />

            {game.phase === 'lobby' && (
              <>
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-xl font-bold">Spillere ({playersArr.length})</h2>
                  <div className="text-sm text-gray-600">Minst 3 for √• starte</div>
                </div>
                <div className="grid grid-cols-2 gap-3 mb-4">
                  {playersArr.map(p=>(
                    <div key={p.id} className="bg-gradient-to-r from-purple-50 to-pink-50 p-3 rounded flex justify-between items-center">
                      <div><div className="font-bold">{p.name}</div><div className="text-sm text-gray-500">Poeng: {p.score || 0}</div></div>
                      {game.imposter === p.id && <div className="text-xs text-red-500 font-semibold">IMPOSTER</div>}
                    </div>
                  ))}
                </div>
                <div className="flex gap-3">
                  <button className="flex-1 bg-green-500 text-white py-3 rounded" onClick={startGame}>Start spillet</button>
                  <button className="bg-gray-100 px-4 py-3 rounded" onClick={playAgain}>Nullstill runde</button>
                </div>
              </>
            )}

            {game.phase === 'showWord' && (
              <div className="text-center py-6">
                <h2 className="text-xl font-bold mb-3">{isImposter ? 'Du er imposteren' : 'Memoriser ordet'}</h2>
                {!isImposter ? <div className="inline-block bg-yellow-300 px-8 py-6 rounded-2xl text-3xl font-bold text-white">{game.word}</div>
                : <div className="inline-block bg-red-400 px-8 py-6 rounded-2xl text-white font-bold">Du vet ikke ordet ‚Äî pr√∏v √• blande deg inn</div>}
                <p className="text-gray-600 mt-3">Kategori: {game.category === 'dyr' ? 'üêæ Dyr' : 'üîß Ting'}</p>
              </div>
            )}

            {game.phase === 'discussion' && (
              <div className="text-center py-6">
                <h2 className="text-xl font-bold mb-2">Diskusjon</h2>
                <p className="text-gray-600 mb-4">Diskuter og finn imposteren.</p>
                <button className="bg-blue-500 text-white px-6 py-3 rounded" onClick={startVoting}>Start avstemning</button>
              </div>
            )}

            {game.phase === 'voting' && (
              <div className="py-4">
                <h2 className="text-xl font-bold text-center mb-4">Stem p√• imposteren</h2>
                <div className="grid grid-cols-2 gap-3 mb-3">
                  {playersArr.map(p=>(
                    <button key={p.id} className="p-4 rounded bg-gradient-to-r from-purple-400 to-pink-400 text-white font-bold" onClick={()=>castVote(currentPlayer.id, p.id)}>
                      <div>{p.name}</div>
                      <div className="text-sm">{Object.values(game.votes||{}).filter(v=>v===p.id).length} stemmer</div>
                    </button>
                  ))}
                </div>
                <div className="text-center text-gray-600">{Object.keys(game.votes||{}).length} / {playersArr.length} har stemt</div>
              </div>
            )}

            {game.phase === 'results' && (
              <div className="py-4 text-center">
                <h2 className="text-xl font-bold mb-3">Resultater</h2>
                <div className="bg-purple-50 p-4 rounded mb-3">
                  <div>Ordet var: <strong>{game.word}</strong></div>
                  <div>Imposteren var: <strong className="text-red-600">{imposterPlayer?.name}</strong></div>
                  <div>Dere stemte p√•: <strong className="text-orange-600">{suspectPlayer?.name}</strong></div>
                </div>

                <div className="mb-4 text-left">
                  <h3 className="font-bold mb-2">Poeng</h3>
                  <div className="space-y-2">
                    {playersArr.slice().sort((a,b)=> (b.score||0)-(a.score||0)).map((p,i)=>(
                      <div key={p.id} className="flex justify-between bg-white p-2 rounded border">
                        <div>{i===0 ? 'üëë ' : ''}{p.name}</div>
                        <div className="font-bold">{p.score||0}</div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="flex gap-3 justify-center">
                  <button className="bg-green-500 text-white px-4 py-2 rounded" onClick={playAgain}>Spill igjen</button>
                  <button className="bg-gray-100 px-4 py-2 rounded" onClick={async ()=>{ await leaveRoomCleanup(); setRoomCode(''); setCurrentPlayer(null); }}>Avslutt</button>
                </div>
              </div>
            )}

          </div>
        </div>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
