<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imposter â€” Online</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    html, body, #root { height: 100%; }
    .scroll-smooth { scroll-behavior: smooth; }
    .scrollbar-thin::-webkit-scrollbar { width: 5px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1a1a2e; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #4a4e69; border-radius: 20px; }
  </style>
</head>
<body class="antialiased bg-gradient-to-br from-gray-900 via-purple-900 to-violet-800 text-white">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, memo } = React;

    // --- CONFIG: Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAXVyAz8g5HJVSM-kra258NjXLdUEVu2ZI",
      authDomain: "imposter-9d3d4.firebaseapp.com",
      projectId: "imposter-9d3d4",
      databaseURL: "https://imposter-9d3d4-default-rtdb.europe-west1.firebasedatabase.app/",
      storageBucket: "imposter-9d3d4.appspot.com",
      messagingSenderId: "744643944793",
      appId: "1:744643944793:web:ef1a768eabaa2c580c2c48"
    };

    const isConfigSet = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL;

    if (isConfigSet) {
      firebase.initializeApp(firebaseConfig);
      var db = firebase.database();
    }

    // --- EXPANDED WORD DATABASE ---
    const WORDS = {
      dyr: {
        lett: ['Hund','Katt','Ku','Gris','Hest','Sau','Mus','Elefant','Tiger','BjÃ¸rn','Hai','Kanin','And','Ugle','Rev','Slange','Ape','LÃ¸ve','Krokodille','Frosk'],
        middels: ['Pingvin','Delfin','Kenguru','PapegÃ¸ye','Zebra','Giraff','Panda','Koala','Leopard','Neshorn','Kamel','Struts','Flodhest','Gorilla','Gepard','Kameleont','Lemur','Piggsvin','Sebra','VaskebjÃ¸rn'],
        vanskelig: ['Tapir','Ozelot','Kapybara','Okapi','Numbat','Quokka','Vombat','Axolotl','Pangolin','Narvhal','Tukan','Lemming','Alpakka','Marabustork','Flamingo','Sloth','Fennek','Mink','Lemen','Chinchilla']
      },
      ting: {
        lett: ['Telefon','Blyant','Bok','Lampe','Stol','Bord','Seng','Sofa','TV','Klokke','Paraply','Sko','Sekk','Kopp','Tallerken','Kniv','Gaffel','DÃ¸r','Vindu','Speil'],
        middels: ['Piano','Kompass','Teleskop','Koffert','Lommelykt','Mikrofon','Kamera','Sykkel','Skateboard','Trampoline','Hammer','Laptop','Saksofon','Fele','Gitar','Trompet','Klarinett','Kontrabass','Xylofon','Mundharmonika'],
        vanskelig: ['Sekstant','Astrolabium','Metronom','Karabinkrok','Kaleidoskop','Kikkerter','Periskop','Tuner','Stemmegaffel','Pedalboard','Distorsjonspedal','Equalizer','Kompressor','Synthesizer','Oud','Sitar','Balalaika','Theremin','Kantele','Didgeridoo']
      },
      land: {
        lett: ['Norge','Sverige','Danmark','England','Tyskland','Frankrike','Spania','Italia','USA','Canada','Kina','Japan','Australia','Brasil','Mexico','Egypt','India','Russland','Polen','Hellas'],
        middels: ['Portugal','Belgia','Nederland','Sveits','Ã˜sterrike','Tyrkia','Thailand','Vietnam','Indonesia','Argentina','Chile','Colombia','Peru','Kenya','Marokko','Algerie','Pakistan','Bangladesh','Filippinene','New Zealand'],
        vanskelig: ['Aserbajdsjan','Tadsjikistan','Kirgisistan','Turkmenistan','Moldova','Montenegro','Kosovo','Makedonia','Slovenia','Slovakia','Latvia','Litauen','Estland','Albania','Georgia','Armenia','Uruguay','Paraguay','Bolivia','Ecuador']
      },
      mat: {
        lett: ['Pizza','Hamburger','Taco','Pasta','Ris','BrÃ¸d','Eple','Banan','Appelsin','JordbÃ¦r','Gulrot','Tomat','Salat','Ost','Egg','Yoghurt','Is','Sjokolade','Kjeks','Potetgull'],
        middels: ['Lasagne','Sushi','Burrito','Paella','Risotto','Ratatouille','Croissant','Baguette','Mango','Papaya','Ananas','Avocado','Brokkoli','Asparges','Aubergine','Paprika','Mozzarella','Parmesan','Tiramisu','Pannacotta'],
        vanskelig: ['Bouillabaisse','Ramen','Pho','Bibimbap','Bulgogi','Carbonara','Ossobuco','Cioppino','Coq au vin','Cassoulet','Tagine','Moussaka','Ceviche','Poke','Shakshuka','Borscht','Pierogi','Goulash','Schnitzel','Stroganoff']
      },
      yrker: {
        lett: ['LÃ¦rer','Lege','Sykepleier','Politi','Brannmann','Kokk','Baker','FrisÃ¸r','Tannlege','Pilot','SjÃ¥fÃ¸r','Bonde','Fisker','Snekker','RÃ¸rlegger','Elektriker','Maler','Selger','Kassemedarbeider','Vaktmester'],
        middels: ['Arkitekt','IngeniÃ¸r','Advokat','Psykolog','Fysioterapeut','Kiropraktor','Optiker','FarmasÃ¸yt','VeterinÃ¦r','Journalist','Fotograf','Designer','Programmerer','Ã˜konom','Revisor','MarkedsfÃ¸rer','Eiendomsmegler','Resepsjonist','Bartender','ServitÃ¸r'],
        vanskelig: ['AktuĞ°Ñ€','Seismolog','Meteorolog','Oceanograf','Paleontolog','Arkeolog','Antropolog','Etnograf','Genealog','Sommelier','Curator','Konservator','Restaurator','Koreograf','Dramaturg','Scenograf','Kostymedesigner','Lyddesigner','Colorist','Gaffer']
      },
      sport: {
        lett: ['Fotball','HÃ¥ndball','Basketball','Tennis','Golf','SvÃ¸mming','Sykling','LÃ¸ping','Ski','SkÃ¸yter','Volleyball','Bordtennis','Badminton','Boksing','Karate','Judo','Turn','Friidrett','Ridning','Dans'],
        middels: ['Curling','Skiskyting','Alpint','Langrenn','Snowboard','Skateboard','Surfing','Klatring','Baseball','Rugby','Cricket','Ishockey','Vannpolo','Dragkamp','Fekting','Bryting','VektlÃ¸fting','Triatlon','Sykkelkross','BMX'],
        vanskelig: ['Lacrosse','Sepaktakraw','Jai alai','Korfball','Bandy','Floorball','Hurling','Kabaddi','Bossaball','Tchoukball','Ultimate frisbee','Footgolf','Padel','Pickleball','PesÃ¤pallo','Ringette','Synchronized skating','Speedminton','Underwater rugby','Cycle ball']
      },
      steder: {
        lett: ['Strand','Fjell','Skog','Park','Bibliotek','Kino','Restaurant','KafÃ©','Butikk','Skole','Sykehus','Flyplass','Togstasjon','Busstopp','Hotell','Museum','Kirke','Stadion','SvÃ¸mmehall','Lekeplass'],
        middels: ['Katedral','Slott','Festning','Tempel','MoskÃ©','Synagoge','Observatorium','Akvarium','Dyrehage','Botanisk hage','Galleri','Teater','Operahus','Konserthus','Amfiteater','Marina','Havn','Kai','Brygge','FyrtÃ¥rn'],
        vanskelig: ['Mausoleum','Akropolis','Akvedukt','Kolosseum','Parthenon','Stonehenge','Machu Picchu','Angkor Wat','Petra','Taj Mahal','Alhambra','Sagrada Familia','Notre-Dame','Westminster Abbey','Sistine Chapel','Hagia Sophia','Blue Mosque','Mezquita','Kinkaku-ji','Fushimi Inari']
      },
      kjendiser: {
        lett: ['Ronaldo','Messi','Ibrahimovic','Haaland','Ã˜degaard','Mbappe','Neymar','Beckham','Tiger Woods','Usain Bolt','Michael Jordan','LeBron James','Serena Williams','Roger Federer','Nadal','Muhammad Ali','Mike Tyson','Maradona','Pele','Michael Phelps'],
        middels: ['Magnus Carlsen','Ada Hegerberg','Therese Johaug','Karsten Warholm','Johannes Thingnes BÃ¸','Novak Djokovic','Simone Biles','Lewis Hamilton','Max Verstappen','Tom Brady','Stephen Curry','Kobe Bryant','Shaquille ONeal','Marta','Alex Morgan','Kylian MbappÃ©','Erling Braut Haaland','Martin Ã˜degaard','Caroline Wozniacki','Jan Frodeno'],
        vanskelig: ['Eliud Kipchoge','Armand Duplantis','Mondo Duplantis','Jakob Ingebrigtsen','Karoline Bjerkeli GrÃ¸vdal','Sifan Hassan','Sydney McLaughlin','Caeleb Dressel','Katie Ledecky','Adam Peaty','Ariarne Titmus','Emma McKeon','Caleb Dressel','Katinka HosszÃº','Sarah SjÃ¶strÃ¶m','Yuliya Efimova','Sun Yang','Gregorio Paltrinieri','Florent Manaudou','Chad le Clos']
      }
    };

    // Hints for imposters based on category
    const IMPOSTER_HINTS = {
      dyr: {
        lett: ['Et vanlig husdyr','Et dyr de fleste kjenner','Et kjent dyr','Et populÃ¦rt dyr'],
        middels: ['Et eksotisk dyr','Et dyr med spesielle egenskaper','Et dyr fra et annet kontinent','Et mindre kjent dyr'],
        vanskelig: ['Et sjeldent dyr','Et dyr fÃ¥ har hÃ¸rt om','Et uvanlig dyr','Et dyr med unikt utseende']
      },
      ting: {
        lett: ['En gjenstand du bruker ofte','Noe de fleste har hjemme','En vanlig gjenstand','Noe du ser hver dag'],
        middels: ['Et verktÃ¸y eller instrument','En spesiell gjenstand','Noe mer uvanlig','En gjenstand med spesifikk bruk'],
        vanskelig: ['En sjelden gjenstand','Noe svÃ¦rt spesifikt','En avansert gjenstand','Noe eksperter kjenner til']
      },
      land: {
        lett: ['Et velkjent land','Et land de fleste kjenner','Et stort eller kjent land','Et populÃ¦rt land'],
        middels: ['Et land i Europa eller Asia','Et mindre kjent land','Et land med spesiell kultur','Et interessant land'],
        vanskelig: ['Et lite kjent land','Et land fÃ¥ kan plassere','Et uvanlig land','Et land i et spesifikt omrÃ¥de']
      },
      mat: {
        lett: ['En matvare alle kjenner','Noe mange spiser','En populÃ¦r matrett','Mat du finner overalt'],
        middels: ['En internasjonal rett','Mat fra et annet land','En spesiell matrett','Mer uvanlig mat'],
        vanskelig: ['En sjelden rett','En gourmet-rett','Mat fra et spesifikt land','En sofistikert matrett']
      },
      yrker: {
        lett: ['Et vanlig yrke','Et yrke de fleste kjenner','En jobb mange har','Et hverdagslig yrke'],
        middels: ['Et yrke med utdanning','Et mer spesialisert yrke','En mindre vanlig jobb','Et spesifikt yrke'],
        vanskelig: ['Et sjeldent yrke','En svÃ¦rt spesialisert jobb','Et yrke fÃ¥ har','Et ekspertyrke']
      },
      sport: {
        lett: ['En populÃ¦r idrett','En sport de fleste kjenner','En velkjent idrett','En vanlig sport'],
        middels: ['En mindre vanlig sport','En idrett med utstyr','En spesiell sport','En internasjonal idrett'],
        vanskelig: ['En sjelden sport','En ekstremsport','En sport fÃ¥ kjenner','En uvanlig idrett']
      },
      steder: {
        lett: ['Et sted du ofte besÃ¸ker','Et vanlig sted','Et sted i nÃ¦rheten','Et hverdagslig sted'],
        middels: ['Et spesielt sted','Et kulturelt sted','Et sted med historie','Et reisemÃ¥l'],
        vanskelig: ['Et berÃ¸mt landemerke','Et historisk monument','Et verdenskjent sted','Et unikt sted']
      },
      kjendiser: {
        lett: ['En kjent idrettsutÃ¸ver','En superstjerne','En verdenskjent person','En toppidrettsutÃ¸ver'],
        middels: ['En profesjonell utÃ¸ver','En mester i sin idrett','En anerkjent atlet','En konkurransedeltaker'],
        vanskelig: ['En spesialisert atlet','En mesterholder','En rekordinnehaver','En eliteutÃ¸ver']
      }
    };

    const CATEGORY_INFO = {
      dyr: { name: 'Dyr', emoji: 'ğŸ¾', color: 'from-green-600 to-emerald-600' },
      ting: { name: 'Ting', emoji: 'ğŸ”§', color: 'from-blue-600 to-cyan-600' },
      land: { name: 'Land', emoji: 'ğŸŒ', color: 'from-purple-600 to-pink-600' },
      mat: { name: 'Mat', emoji: 'ğŸ•', color: 'from-orange-600 to-red-600' },
      yrker: { name: 'Yrker', emoji: 'ğŸ’¼', color: 'from-indigo-600 to-blue-600' },
      sport: { name: 'Sport', emoji: 'âš½', color: 'from-yellow-600 to-orange-600' },
      steder: { name: 'Steder', emoji: 'ğŸ›ï¸', color: 'from-teal-600 to-green-600' },
      kjendiser: { name: 'Kjendiser', emoji: 'â­', color: 'from-pink-600 to-rose-600' }
    };

    const DIFFICULTY_INFO = {
      lett: { name: 'Lett', emoji: 'ğŸ˜Š', color: 'bg-green-500' },
      middels: { name: 'Middels', emoji: 'ğŸ˜', color: 'bg-yellow-500' },
      vanskelig: { name: 'Vanskelig', emoji: 'ğŸ˜°', color: 'bg-red-500' }
    };

    function generateRoomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    function generateId(prefix = '') { return prefix + Math.random().toString(36).substring(2, 9); }

    const MemoizedGameScreen = memo(GameScreen);

    function App() {
      const [playerName, setPlayerName] = useState('');
      const [roomInput, setRoomInput] = useState('');
      const [roomCode, setRoomCode] = useState('');
      const [game, setGame] = useState(null);
      const [currentPlayer, setCurrentPlayer] = useState(null);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      
      const roomRef = useRef(null);

      useEffect(() => {
        if (!isConfigSet) return;
        const onUnload = () => leaveRoomCleanup();
        window.addEventListener('beforeunload', onUnload);
        return () => window.removeEventListener('beforeunload', onUnload);
      }, [roomCode, currentPlayer, game]);

      useEffect(() => {
        if (!isConfigSet || !roomCode) {
          if (roomRef.current) roomRef.current.off();
          setGame(null);
          return;
        }
        roomRef.current = db.ref('rooms/' + roomCode);
        roomRef.current.on('value', snapshot => {
          const val = snapshot.val();
          setGame(val || null);
          if (!val) {
             setError(`Rom "${roomCode}" finnes ikke lenger.`);
             setRoomCode('');
             setCurrentPlayer(null);
          }
        });
        return () => { if (roomRef.current) roomRef.current.off(); };
      }, [roomCode]);

      async function handleRoomAction(action) {
        setError('');
        const name = playerName.trim();
        const code = roomInput.trim().toUpperCase();
        if (!name) return setError('Skriv inn navnet ditt.');
        if (action === 'join' && !code) return setError('Skriv inn rom-koden.');
        if (!isConfigSet) return setError("Firebase-konfig mangler.");
        setLoading(true);

        try {
          let gameCode = action === 'create' ? await createNewRoom(name) : code;
          if (action === 'join') await joinExistingRoom(name, gameCode);
          setRoomCode(gameCode);
        } catch (err) {
          console.error(err);
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }

      async function createNewRoom(name) {
        let code = generateRoomCode();
        let tries = 0;
        while(tries < 5) {
            const snap = await db.ref('rooms/' + code).once('value');
            if (!snap.exists()) break;
            code = generateRoomCode();
            tries++;
        }
        if (tries >= 5) throw new Error("Klarte ikke Ã¥ lage unikt rom. PrÃ¸v igjen.");

        const pid = generateId('p_');
        const player = { id: pid, name, score: 0, joinedAt: Date.now(), isHost: true };
        const gameObj = {
          code,
          phase: 'lobby',
          host: pid,
          players: { [pid]: player },
          difficulty: 'middels',
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        await db.ref('rooms/' + code).set(gameObj);
        setCurrentPlayer(player);
        return code;
      }

      async function joinExistingRoom(name, code) {
        const roomSnap = await db.ref('rooms/' + code).once('value');
        if (!roomSnap.exists()) throw new Error(`Rom "${code}" finnes ikke.`);
        
        const roomData = roomSnap.val();
        const names = Object.values(roomData.players || {}).map(p => p.name.toLowerCase());
        if (names.includes(name.toLowerCase())) throw new Error('Dette navnet er allerede i bruk.');

        const pid = generateId('p_');
        const player = { id: pid, name, score: 0, joinedAt: Date.now() };
        await db.ref(`rooms/${code}/players/${pid}`).set(player);
        setCurrentPlayer(player);
      }
      
      async function leaveRoomCleanup() {
        if (!game || !currentPlayer) return;
        const { code, players, imposter, host } = game;
        const pid = currentPlayer.id;

        await db.ref(`rooms/${code}/players/${pid}`).remove();

        const remainingPlayers = Object.keys(players || {}).filter(id => id !== pid);
        if (remainingPlayers.length === 0) {
          await db.ref(`rooms/${code}`).remove();
        } else {
            if(imposter === pid && game.phase !== 'lobby') {
                db.ref(`rooms/${code}`).update({
                    phase: 'lobby', word: null, category: null, imposter: null, imposterHint: null
                });
                await db.ref(`rooms/${code}/votes`).remove();
                await db.ref(`rooms/${code}/suspectId`).remove();
                await db.ref(`rooms/${code}/chat`).remove();
                await db.ref(`rooms/${code}/turn`).remove();
                await db.ref(`rooms/${code}/playerOrder`).remove();
            }
            if(host === pid) { 
                const newHostId = remainingPlayers.sort((a,b) => players[a].joinedAt - players[b].joinedAt)[0];
                db.ref(`rooms/${code}/host`).set(newHostId);
            }
        }
      }

      async function handleLeave() {
        await leaveRoomCleanup();
        setRoomCode('');
        setCurrentPlayer(null);
        setGame(null);
        setError('');
        setRoomInput('');
      }

      // --- UI rendering ---

      if (!isConfigSet) {
        return <div className="h-full flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl max-w-lg text-center shadow-lg">
            <h1 className="text-2xl font-bold mb-4">Firebase-konfig mangler</h1>
            <p className="text-gray-300 mb-4">Lim inn Firebase-konfigen i toppen av <code>index.html</code>.</p>
          </div>
        </div>;
      }

      if (!roomCode || !currentPlayer || !game) {
        return <div className="h-full flex items-center justify-center p-4">
          <div className="max-w-md w-full bg-white/10 backdrop-blur-md rounded-3xl p-8 shadow-2xl border border-white/20">
            {/* Header */}
            <div className="text-center mb-8">
              <h1 className="text-5xl font-extrabold mb-3 bg-gradient-to-r from-purple-400 via-pink-400 to-rose-400 bg-clip-text text-transparent">
                IMPOSTER
              </h1>
              <p className="text-gray-300 text-sm">Finn imposteren blant dere! ğŸ•µï¸</p>
            </div>

            {/* Error Message */}
            {error && (
              <div className="mb-6 p-4 rounded-xl bg-red-500/20 border border-red-500/50 text-red-200 text-center text-sm animate-pulse">
                âš ï¸ {error}
              </div>
            )}

            {/* Name Input */}
            <div className="mb-6">
              <label className="block text-sm font-semibold text-gray-300 mb-2">
                ğŸ“ Ditt navn
              </label>
              <input 
                className="w-full p-4 bg-black/30 border border-white/20 rounded-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition" 
                placeholder="Skriv navnet ditt..." 
                value={playerName} 
                onChange={e => setPlayerName(e.target.value)}
                maxLength={20}
              />
            </div>

            {/* Create Room Button */}
            <button 
              className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 rounded-xl mb-6 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg transform hover:scale-[1.02] active:scale-[0.98]" 
              onClick={() => handleRoomAction('create')} 
              disabled={loading}
            >
              {loading ? (
                <span className="flex items-center justify-center gap-2">
                  <span className="animate-spin">â³</span> Lager rom...
                </span>
              ) : (
                <span className="flex items-center justify-center gap-2">
                  âœ¨ Lag nytt rom
                </span>
              )}
            </button>

            {/* Divider */}
            <div className="relative my-6">
              <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-white/20"></div>
              </div>
              <div className="relative flex justify-center text-sm">
                <span className="px-4 bg-white/10 text-gray-400 rounded-full">eller</span>
              </div>
            </div>

            {/* Join Room Section */}
            <div className="space-y-3">
              <label className="block text-sm font-semibold text-gray-300">
                ğŸšª Bli med i rom
              </label>
              <div className="flex gap-3">
                <input 
                  className="flex-grow p-4 bg-black/30 border border-white/20 rounded-xl placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition uppercase tracking-wider font-mono" 
                  placeholder="ROM-KODE" 
                  value={roomInput} 
                  onChange={e => setRoomInput(e.target.value.toUpperCase())}
                  maxLength={6}
                />
                <button 
                  className="bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700 text-white font-bold py-4 px-6 rounded-xl transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg transform hover:scale-[1.02] active:scale-[0.98]" 
                  onClick={() => handleRoomAction('join')} 
                  disabled={loading}
                >
                  {loading ? 'â³' : 'ğŸš€'}
                </button>
              </div>
            </div>

            {/* Footer Info */}
            <div className="mt-8 pt-6 border-t border-white/10 text-center text-xs text-gray-400">
              <p>ğŸ’¡ Tips: Spillet krever minimum 3 spillere</p>
            </div>
          </div>
        </div>;
      }
      
      return <MemoizedGameScreen game={game} currentPlayer={currentPlayer} onLeave={handleLeave} />
    }

    function GameScreen({ game, currentPlayer, onLeave }) {
      const [chatInput, setChatInput] = useState('');
      const chatEndRef = useRef(null);
      const inputRef = useRef(null);

      useEffect(() => {
        if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
      }, [game?.chat?.messages]);

      async function startGame() {
        try {
          if (!game) return;
          const playersArr = Object.values(game.players || {});
          if (playersArr.length < 3) return;

          // Shuffle players array for true randomization
          const shuffledPlayers = playersArr.sort(() => Math.random() - 0.5);

          const categories = Object.keys(WORDS);
          const category = categories[Math.floor(Math.random() * categories.length)];
          const difficulty = game.difficulty || 'middels';
          const wordsInCategory = WORDS[category][difficulty];
          const word = wordsInCategory[Math.floor(Math.random() * wordsInCategory.length)];
          
          // Pick imposter from shuffled array
          const imposter = shuffledPlayers[Math.floor(Math.random() * shuffledPlayers.length)].id;
          const playerOrder = playersArr.map(p => p.id).sort(() => Math.random() - 0.5);
          
          const hints = IMPOSTER_HINTS[category][difficulty];
          const imposterHint = hints[Math.floor(Math.random() * hints.length)];

          const roomRef = db.ref(`rooms/${game.code}`);
          await roomRef.update({ 
            phase: 'showWord', 
            category, 
            word, 
            imposter, 
            imposterHint,
            turn: 0, 
            playerOrder 
          });
          await roomRef.child('votes').remove();
          await roomRef.child('suspectId').remove();
          await roomRef.child('chat').remove();

          setTimeout(() => roomRef.child('phase').set('discussion'), 8000);
        } catch (err) {
          console.error("StartGame error:", err);
          alert(err.message);
        }
      }

      async function changeDifficulty(diff) {
        if (!game || currentPlayer.id !== game.host) return;
        await db.ref(`rooms/${game.code}/difficulty`).set(diff);
      }

      async function sendChatMessage(e) {
        e.preventDefault();
        if (!chatInput.trim() || !game || currentPlayer.id !== game.playerOrder[game.turn]) return;
        
        const message = {
          senderId: currentPlayer.id,
          senderName: currentPlayer.name,
          text: chatInput.trim(),
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        const newMsgRef = db.ref(`rooms/${game.code}/chat/messages`).push();
        await newMsgRef.set(message);

        const nextTurn = (game.turn + 1) % game.playerOrder.length;
        await db.ref(`rooms/${game.code}/turn`).set(nextTurn);
        setChatInput('');
        
        if (inputRef.current) {
          setTimeout(() => inputRef.current.focus(), 50);
        }
      }

      async function castVote(votedForId) {
        if (!game || !currentPlayer || game.votes?.[currentPlayer.id]) return;
        await db.ref(`rooms/${game.code}/votes/${currentPlayer.id}`).set(votedForId);
        
        const pSnap = await db.ref(`rooms/${game.code}/players`).once('value');
        const vSnap = await db.ref(`rooms/${game.code}/votes`).once('value');
        const numPlayers = pSnap.exists() ? Object.keys(pSnap.val()).length : 0;
        const numVotes = vSnap.exists() ? Object.keys(vSnap.val()).length : 0;

        if (numVotes >= numPlayers) showResults(vSnap.val());
      }

      async function showResults(votesObj) {
        const votes = votesObj || {};
        const counts = {};
        Object.values(votes).forEach(id => { counts[id] = (counts[id] || 0) + 1; });
        
        let max = -1, suspectId = null;
        Object.entries(counts).forEach(([id, c]) => {
            if (c > max || (c === max && id < suspectId)) { max = c; suspectId = id; }
        });

        const players = { ...game.players };
        const imposterWasFound = suspectId === game.imposter;
        Object.keys(players).forEach(pid => {
          if (imposterWasFound && pid !== game.imposter) players[pid].score += 1;
          else if (!imposterWasFound && pid === game.imposter) players[pid].score += 2;
        });

        await db.ref(`rooms/${game.code}`).update({ phase: 'results', suspectId, players });
      }

      async function playAgain() {
        if (!game) return;
        const roomRef = db.ref(`rooms/${game.code}`);
        await roomRef.update({ phase: 'lobby', word: null, category: null, imposter: null, imposterHint: null });
        await roomRef.child('votes').remove();
        await roomRef.child('suspectId').remove();
        await roomRef.child('chat').remove();
        await roomRef.child('turn').remove();
        await roomRef.child('playerOrder').remove();
      }

      const playersArr = Object.values(game.players || {});
      const isImposter = currentPlayer.id === game.imposter;
      const me = game.players[currentPlayer.id];
      const isHost = currentPlayer.id === game.host;
      const difficulty = game.difficulty || 'middels';
      const categoryInfo = CATEGORY_INFO[game.category] || {};

      const MainContent = () => {
        switch(game.phase) {
          case 'lobby':
            return <>
              <div className="mb-6">
                <h2 className="text-3xl font-bold mb-2">ğŸ® Lobby</h2>
                <p className="text-gray-400">Venter pÃ¥ at spillere skal bli med...</p>
              </div>

              {isHost && (
                <div className="mb-6 bg-white/5 rounded-xl p-4 border border-white/10">
                  <h3 className="text-lg font-semibold mb-3">âš™ï¸ Vanskelighetsgrad</h3>
                  <div className="grid grid-cols-3 gap-3">
                    {Object.entries(DIFFICULTY_INFO).map(([key, info]) => (
                      <button
                        key={key}
                        onClick={() => changeDifficulty(key)}
                        className={`p-3 rounded-lg font-semibold transition transform hover:scale-105 ${
                          difficulty === key 
                            ? info.color + ' text-white shadow-lg' 
                            : 'bg-white/10 hover:bg-white/20'
                        }`}
                      >
                        <div className="text-2xl mb-1">{info.emoji}</div>
                        <div className="text-sm">{info.name}</div>
                      </button>
                    ))}
                  </div>
                  <p className="text-xs text-gray-400 mt-2 text-center">
                    {difficulty === 'lett' && 'Perfekt for nybegynnere! ğŸ˜Š'}
                    {difficulty === 'middels' && 'Balansert utfordring for de fleste ğŸ˜'}
                    {difficulty === 'vanskelig' && 'For de som elsker en utfordring! ğŸ˜°'}
                  </p>
                </div>
              )}

              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                {playersArr.map(p => (
                  <div key={p.id} className="bg-gradient-to-br from-white/10 to-white/5 p-4 rounded-xl text-center backdrop-blur-sm border border-white/10 hover:border-purple-500/50 transition">
                    <div className="font-bold text-lg mb-1">
                      {p.name} {game.host === p.id && 'ğŸ‘‘'}
                    </div>
                    <div className="text-sm text-purple-300">ğŸ† {p.score || 0} poeng</div>
                  </div>
                ))}
              </div>

              {isHost && (
                <button 
                  className={`w-full text-white font-bold py-4 px-6 rounded-xl transition transform text-lg shadow-lg ${
                    playersArr.length < 3 
                      ? 'bg-gray-600 opacity-50 cursor-not-allowed' 
                      : 'bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 hover:scale-105'
                  }`}
                  disabled={playersArr.length < 3} 
                  onClick={startGame}
                >
                  {playersArr.length < 3 ? `ğŸ”’ Trenger ${3 - playersArr.length} spiller(e) til` : 'ğŸš€ Start Spillet!'}
                </button>
              )}
            </>;
          
          case 'showWord':
            return <div className="text-center py-10">
              {isImposter ? (
                <>
                  <h2 className="text-4xl font-bold mb-6 animate-pulse">ğŸ­ Du er Imposteren!</h2>
                  <div className="inline-block bg-gradient-to-r from-red-600 to-rose-600 px-12 py-10 rounded-3xl shadow-2xl mb-6">
                    <div className="text-3xl font-bold mb-3">ğŸ¤« Hemmelig Oppdrag</div>
                    <div className="text-xl text-red-100">Bland inn og ikke bli avslÃ¸rt!</div>
                  </div>
                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6 max-w-md mx-auto border border-red-500/30">
                    <p className="text-sm text-gray-300 mb-2">ğŸ’¡ Hint:</p>
                    <p className="text-lg font-semibold text-red-300">{game.imposterHint}</p>
                  </div>
                </>
              ) : (
                <>
                  <h2 className="text-3xl font-bold mb-6">ğŸ” Ditt hemmelige ord:</h2>
                  <div className={`inline-block bg-gradient-to-r ${categoryInfo.color} px-12 py-10 rounded-3xl shadow-2xl`}>
                    <div className="text-5xl font-bold mb-2">{game.word}</div>
                  </div>
                  <div className="mt-6 inline-block bg-white/10 backdrop-blur-sm px-6 py-3 rounded-xl border border-white/20">
                    <p className="text-lg">
                      <span className="text-2xl mr-2">{categoryInfo.emoji}</span>
                      <span className="font-semibold">{categoryInfo.name}</span>
                    </p>
                  </div>
                </>
              )}
              <p className="mt-8 text-gray-300 text-lg animate-bounce">â³ Diskusjonen starter om noen sekunder...</p>
            </div>;
          
          case 'discussion':
            const currentTurnPlayer = game.players[game.playerOrder[game.turn]];
            const sortedMessages = Object.entries(game.chat?.messages || {}).sort(([,a],[,b]) => a.timestamp - b.timestamp);
            return <div className="flex flex-col h-full">
              <div className="bg-white/5 backdrop-blur-sm rounded-xl p-4 mb-4 border border-white/10">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">{categoryInfo.emoji}</span>
                    <span className="font-semibold">{categoryInfo.name}</span>
                    <span className="text-sm text-gray-400">â€¢</span>
                    <span className="text-sm text-gray-400">{DIFFICULTY_INFO[difficulty].name}</span>
                  </div>
                  {currentTurnPlayer && (
                    <div className="text-sm text-purple-300">
                      ğŸ¤ <span className="font-semibold">{currentTurnPlayer.name}</span> sin tur
                    </div>
                  )}
                </div>
              </div>

              <div className="flex-1 overflow-y-auto scrollbar-thin mb-3 bg-black/20 rounded-xl p-4">
                <div className="space-y-2">
                  {sortedMessages.length === 0 && (
                    <div className="text-center text-gray-500 py-8">
                      <p className="text-lg">ğŸ’¬ Diskuter ordet!</p>
                      <p className="text-sm mt-2">Si noe relatert til ordet uten Ã¥ avslÃ¸re det</p>
                    </div>
                  )}
                  {sortedMessages.map(([id,msg]) => (
                    <div key={id} className={`p-3 rounded-xl transition ${
                      msg.senderId === currentPlayer.id 
                        ? 'bg-gradient-to-r from-purple-600/60 to-pink-600/60 text-right ml-8' 
                        : 'bg-white/10 text-left mr-8'
                    }`}>
                      <div className="font-semibold text-sm mb-1">{msg.senderName}</div>
                      <div className="text-base">{msg.text}</div>
                    </div>
                  ))}
                  <div ref={chatEndRef}></div>
                </div>
              </div>

              {currentTurnPlayer?.id === currentPlayer.id ? (
                <form onSubmit={sendChatMessage} className="flex gap-2">
                  <input 
                    ref={inputRef}
                    value={chatInput} 
                    onChange={e => setChatInput(e.target.value)} 
                    placeholder="Si noe relatert til ordet..." 
                    className="flex-grow p-4 rounded-xl bg-black/30 border border-purple-500/50 focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none placeholder-gray-500"
                    autoFocus
                  />
                  <button type="submit" className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-6 rounded-xl font-bold transition">
                    ğŸ“¤ Send
                  </button>
                </form>
              ) : (
                <div className="text-center text-gray-400 py-4 bg-white/5 rounded-xl">
                  {currentTurnPlayer ? (
                    <>
                      â³ Venter pÃ¥ <span className="font-semibold text-purple-300">{currentTurnPlayer.name}</span>...
                    </>
                  ) : 'Vent litt...'}
                </div>
              )}

              {isHost && (
                <button 
                  onClick={() => db.ref(`rooms/${game.code}/phase`).set('voting')} 
                  className="mt-3 bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700 px-6 py-4 rounded-xl w-full font-bold transition transform hover:scale-105 shadow-lg"
                >
                  ğŸ—³ï¸ Start Avstemning
                </button>
              )}
            </div>;
          
          case 'voting':
            return <div className="text-center">
              <h2 className="text-4xl font-bold mb-6">ğŸ•µï¸ Hvem er Imposteren?</h2>
              <p className="text-gray-300 mb-6">Stem pÃ¥ personen du tror er imposteren</p>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                {playersArr.map(p => {
                  const hasVoted = game.votes?.[currentPlayer.id] === p.id;
                  return (
                    <button 
                      key={p.id} 
                      onClick={() => castVote(p.id)} 
                      className={`p-6 rounded-xl transition transform hover:scale-105 ${
                        hasVoted 
                          ? 'bg-gradient-to-r from-purple-700 to-pink-700 shadow-lg ring-2 ring-purple-400' 
                          : 'bg-white/10 hover:bg-white/20'
                      }`}
                    >
                      <div className="text-2xl mb-2">{hasVoted ? 'âœ…' : 'ğŸ‘¤'}</div>
                      <div className="font-bold text-lg">{p.name}</div>
                    </button>
                  );
                })}
              </div>
              <div className="bg-white/5 backdrop-blur-sm rounded-xl p-4 border border-white/10">
                <p className="text-lg">
                  <span className="font-bold text-purple-300">{Object.keys(game.votes || {}).length}</span>
                  <span className="text-gray-400"> / {playersArr.length} har stemt</span>
                </p>
              </div>
            </div>;
          
          case 'results':
            const suspect = game.players[game.suspectId];
            const imposterPlayer = game.players[game.imposter];
            const imposterWasFound = game.suspectId === game.imposter;
            return <div className="text-center py-10">
              <h2 className="text-4xl font-bold mb-8">ğŸ­ Resultat</h2>
              
              <div className="max-w-2xl mx-auto space-y-6 mb-8">
                <div className="bg-gradient-to-r from-purple-600/30 to-pink-600/30 backdrop-blur-sm p-6 rounded-2xl border border-white/20">
                  <p className="text-lg mb-2 text-gray-300">Dere stemte pÃ¥:</p>
                  <p className="text-3xl font-bold text-purple-300">{suspect?.name || '?'}</p>
                </div>

                <div className={`bg-gradient-to-r ${
                  imposterWasFound 
                    ? 'from-green-600/30 to-emerald-600/30 border-green-500/50' 
                    : 'from-red-600/30 to-rose-600/30 border-red-500/50'
                } backdrop-blur-sm p-6 rounded-2xl border`}>
                  <p className="text-lg mb-2 text-gray-300">Imposteren var:</p>
                  <p className="text-3xl font-bold text-red-300 mb-3">{imposterPlayer?.name}</p>
                  <p className="text-xl">
                    {imposterWasFound ? 'âœ… Imposteren ble funnet!' : 'âŒ Imposteren klarte Ã¥ lure dere!'}
                  </p>
                </div>

                <div className="bg-white/5 backdrop-blur-sm p-6 rounded-2xl border border-white/10">
                  <p className="text-lg mb-2 text-gray-300">Ordet var:</p>
                  <p className="text-3xl font-bold">{game.word}</p>
                  <p className="text-sm text-gray-400 mt-2">
                    <span className="text-xl mr-1">{categoryInfo.emoji}</span>
                    {categoryInfo.name} - {DIFFICULTY_INFO[difficulty].name}
                  </p>
                </div>
              </div>

              <h3 className="text-2xl font-bold mb-4">ğŸ† Poengtavle</h3>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                {playersArr.sort((a, b) => b.score - a.score).map((p, idx) => (
                  <div key={p.id} className="bg-gradient-to-br from-white/10 to-white/5 p-5 rounded-xl border border-white/10">
                    <div className="text-2xl mb-2">
                      {idx === 0 && 'ğŸ¥‡'}
                      {idx === 1 && 'ğŸ¥ˆ'}
                      {idx === 2 && 'ğŸ¥‰'}
                    </div>
                    <div className="font-bold text-lg mb-1">{p.name}</div>
                    <div className="text-xl text-purple-300 font-bold">ğŸ† {p.score}</div>
                    <div className="font-bold text-lg mb-1">{p.name}</div>
                    <div className="text-xl text-purple-300 font-bold">ğŸ† {p.score}</div>
                  </div>
                ))}
              </div>

              {isHost && (
                <button 
                  onClick={playAgain} 
                  className="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold py-4 px-6 rounded-xl transition transform hover:scale-105 shadow-lg"
                >
                  ğŸ”„ Spill Igjen
                </button>
              )}
            </div>;
          
          default:
            return <div className="text-center py-10">
              <p className="text-gray-400">Laster...</p>
            </div>;
        }
      };

      return (
        <div className="h-full flex flex-col bg-gradient-to-br from-gray-900 via-purple-900 to-violet-800">
          {/* Header */}
          <div className="bg-black/30 backdrop-blur-md border-b border-white/10 p-4">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                  IMPOSTER
                </h1>
                <p className="text-sm text-gray-400">Rom: <span className="font-mono font-bold text-purple-300">{game.code}</span></p>
              </div>
              <div className="flex items-center gap-4">
                <div className="text-right">
                  <p className="text-sm text-gray-400">Du er:</p>
                  <p className="font-bold">{me?.name}</p>
                  <p className="text-sm text-purple-300">ğŸ† {me?.score || 0} poeng</p>
                </div>
                <button 
                  onClick={onLeave} 
                  className="bg-red-600/80 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition backdrop-blur-sm"
                >
                  ğŸšª Forlat
                </button>
              </div>
            </div>
          </div>

          {/* Main Content Area */}
          <div className="flex-1 overflow-hidden p-4">
            <div className="max-w-7xl mx-auto h-full bg-black/20 backdrop-blur-sm rounded-2xl border border-white/10 p-6 overflow-y-auto scrollbar-thin">
              <MainContent />
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
