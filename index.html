<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imposter ‚Äî Online</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    html, body, #root { height: 100%; }
    .scroll-smooth { scroll-behavior: smooth; }
    .scrollbar-thin::-webkit-scrollbar { width: 5px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1a1a2e; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #4a4e69; border-radius: 20px; }
  </style>
</head>
<body class="antialiased bg-gradient-to-br from-gray-900 via-purple-900 to-violet-800 text-white">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- CONFIG: Firebase config is set ---
    const firebaseConfig = {
      apiKey: "AIzaSyAXVyAz8g5HJVSM-kra258NjXLdUEVu2ZI",
      authDomain: "imposter-9d3d4.firebaseapp.com",
      projectId: "imposter-9d3d4",
      databaseURL: "https://imposter-9d3d4-default-rtdb.europe-west1.firebasedatabase.app/",
      storageBucket: "imposter-9d3d4.appspot.com",
      messagingSenderId: "744643944793",
      appId: "1:744643944793:web:ef1a768eabaa2c580c2c48"
    };

    const isConfigSet = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL;

    if (isConfigSet) {
      firebase.initializeApp(firebaseConfig);
      var db = firebase.database();
    }

    const WORDS = {
      dyr: ['Elefant','Pingvin','Delfin','Tiger','Kenguru','Bj√∏rn','Rev','Ugle','Hai','Papeg√∏ye','Zebra','Giraff','Panda','Koala','Leopard'],
      ting: ['Piano','Paraply','Kompass','Teleskop','Koffert','Lommelykt','Mikrofon','Kamera','Sykkel','Skateboard','Trampoline','Fyrstikk','Hammer','Laptop']
    };

    function generateRoomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    function generateId(prefix = '') { return prefix + Math.random().toString(36).substring(2, 9); }

    function App() {
      const [playerName, setPlayerName] = useState('');
      const [roomInput, setRoomInput] = useState('');
      const [roomCode, setRoomCode] = useState('');
      const [game, setGame] = useState(null);
      const [currentPlayer, setCurrentPlayer] = useState(null);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      
      const roomRef = useRef(null);

      useEffect(() => {
        if (!isConfigSet) return;
        const onUnload = () => leaveRoomCleanup();
        window.addEventListener('beforeunload', onUnload);
        return () => window.removeEventListener('beforeunload', onUnload);
      }, [roomCode, currentPlayer, game]);

      useEffect(() => {
        if (!isConfigSet || !roomCode) {
          if (roomRef.current) roomRef.current.off();
          setGame(null);
          return;
        }
        roomRef.current = db.ref('rooms/' + roomCode);
        roomRef.current.on('value', snapshot => {
          const val = snapshot.val();
          setGame(val || null);
          if (!val) {
             setError(`Rom "${roomCode}" finnes ikke lenger.`);
             setRoomCode('');
             setCurrentPlayer(null);
          }
        });
        return () => { if (roomRef.current) roomRef.current.off(); };
      }, [roomCode]);

      async function handleRoomAction(action) {
        setError('');
        const name = playerName.trim();
        const code = roomInput.trim().toUpperCase();
        if (!name) return setError('Skriv inn navnet ditt.');
        if (action === 'join' && !code) return setError('Skriv inn rom-koden.');
        if (!isConfigSet) return setError("Firebase-konfig mangler.");
        setLoading(true);

        try {
          let gameCode = action === 'create' ? await createNewRoom(name) : code;
          if (action === 'join') await joinExistingRoom(name, gameCode);
          setRoomCode(gameCode);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }

      async function createNewRoom(name) {
        let code = generateRoomCode();
        let tries = 0;
        while(tries < 5) {
            const snap = await db.ref('rooms/' + code).once('value');
            if (!snap.exists()) break;
            code = generateRoomCode();
            tries++;
        }
        if (tries >= 5) throw new Error("Klarte ikke √• lage unikt rom. Pr√∏v igjen.");

        const pid = generateId('p_');
        const player = { id: pid, name, score: 0, joinedAt: Date.now(), isHost: true };
        const gameObj = {
          code,
          phase: 'lobby',
          host: pid,
          players: { [pid]: player },
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        await db.ref('rooms/' + code).set(gameObj);
        setCurrentPlayer(player);
        return code;
      }

      async function joinExistingRoom(name, code) {
        const roomSnap = await db.ref('rooms/' + code).once('value');
        if (!roomSnap.exists()) throw new Error(`Rom "${code}" finnes ikke.`);
        
        const roomData = roomSnap.val();
        const names = Object.values(roomData.players || {}).map(p => p.name.toLowerCase());
        if (names.includes(name.toLowerCase())) throw new Error('Dette navnet er allerede i bruk.');

        const pid = generateId('p_');
        const player = { id: pid, name, score: 0, joinedAt: Date.now() };
        await db.ref(`rooms/${code}/players/${pid}`).set(player);
        setCurrentPlayer(player);
      }
      
      async function leaveRoomCleanup() {
        if (!game || !currentPlayer) return;
        const { code, players, imposter, host } = game;
        const pid = currentPlayer.id;

        await db.ref(`rooms/${code}/players/${pid}`).remove();

        const remainingPlayers = Object.keys(players || {}).filter(id => id !== pid);
        if (remainingPlayers.length === 0) {
          await db.ref(`rooms/${code}`).remove();
        } else {
            if(imposter === pid && game.phase !== 'lobby') {
                db.ref(`rooms/${code}`).update({
                    phase: 'lobby', word: null, category: null, imposter: null,
                    votes: null, suspectId: null, chat: null, turn: null, playerOrder: null
                });
            }
            if(host === pid) { // If host leaves, assign a new host
                const newHostId = remainingPlayers.sort((a,b) => players[a].joinedAt - players[b].joinedAt)[0];
                db.ref(`rooms/${code}/host`).set(newHostId);
            }
        }
      }

      async function handleLeave() {
        await leaveRoomCleanup();
        setRoomCode('');
        setCurrentPlayer(null);
        setGame(null);
      }

      // --- RENDER ---

      if (!isConfigSet) {
        return <div className="h-full flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl max-w-lg text-center shadow-lg">
            <h1 className="text-2xl font-bold mb-4">Firebase-konfig mangler</h1>
            <p className="text-gray-300 mb-4">Lim inn Firebase-konfigen i toppen av <code>index.html</code> for at online-funksjonen skal fungere.</p>
            <p className="text-xs text-gray-400">G√• til Firebase Console ‚Üí Project settings ‚Üí Your apps ‚Üí SDK snippet ‚Üí Config</p>
          </div>
        </div>;
      }

      if (!roomCode || !currentPlayer || !game) {
        return <div className="h-full flex items-center justify-center p-4">
          <div className="max-w-md w-full bg-white/10 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
            <h1 className="text-5xl font-extrabold text-center mb-6">IMPOSTER</h1>
            {error && <div className="mb-4 p-3 rounded-lg bg-red-500/50 text-white text-center">{error}</div>}
            <input className="w-full p-4 mb-4 bg-black/20 border border-white/20 rounded-lg placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ditt navn" value={playerName} onChange={e => setPlayerName(e.target.value)} />
            <button className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg mb-4 transition duration-300 disabled:opacity-50" onClick={() => handleRoomAction('create')} disabled={loading}>{loading ? 'Lager...' : 'Lag nytt rom'}</button>
            <div className="text-center text-gray-400 my-2">eller</div>
            <div className="flex gap-3">
              <input className="flex-grow p-4 bg-black/20 border border-white/20 rounded-lg placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Rom-kode" value={roomInput} onChange={e => setRoomInput(e.target.value)} />
              <button className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-6 rounded-lg transition duration-300 disabled:opacity-50" onClick={() => handleRoomAction('join')} disabled={loading}>{loading ? '...' : 'Bli med'}</button>
            </div>
          </div>
        </div>;
      }
      
      return <GameScreen game={game} currentPlayer={currentPlayer} onLeave={handleLeave} />
    }

    function GameScreen({ game, currentPlayer, onLeave }) {
      const [chatInput, setChatInput] = useState('');
      const chatEndRef = useRef(null);

      useEffect(() => {
        if (chatEndRef.current) {
          chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, [game?.chat?.messages]);

      async function startGame() {
        if (!game) return;
        const playersArr = Object.values(game.players || {});
        if (playersArr.length < 3) return;

        const category = Math.random() > 0.5 ? 'dyr' : 'ting';
        const word = WORDS[category][Math.floor(Math.random() * WORDS[category].length)];
        const imposter = playersArr[Math.floor(Math.random() * playersArr.length)].id;
        const playerOrder = playersArr.map(p => p.id).sort(() => Math.random() - 0.5); 

        await db.ref(`rooms/${game.code}`).update({
          phase: 'showWord', category, word, imposter,
          votes: null, suspectId: null, chat: null,
          turn: 0, playerOrder,
        });

        setTimeout(() => db.ref(`rooms/${game.code}/phase`).set('discussion'), 8000);
      }

      async function sendChatMessage(e) {
          e.preventDefault();
          if (!chatInput.trim() || !game || currentPlayer.id !== game.playerOrder[game.turn]) return;
          
          const message = {
            senderId: currentPlayer.id,
            senderName: currentPlayer.name,
            text: chatInput.trim(),
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };
          
          const newMsgRef = db.ref(`rooms/${game.code}/chat/messages`).push();
          await newMsgRef.set(message);

          const nextTurn = (game.turn + 1) % game.playerOrder.length;
          await db.ref(`rooms/${game.code}/turn`).set(nextTurn);
          setChatInput('');
      }

      async function castVote(votedForId) {
          if (!game || !currentPlayer || game.votes?.[currentPlayer.id]) return;
          await db.ref(`rooms/${game.code}/votes/${currentPlayer.id}`).set(votedForId);
          
          const pSnap = await db.ref(`rooms/${game.code}/players`).once('value');
          const vSnap = await db.ref(`rooms/${game.code}/votes`).once('value');
          const numPlayers = pSnap.exists() ? Object.keys(pSnap.val()).length : 0;
          const numVotes = vSnap.exists() ? Object.keys(vSnap.val()).length : 0;

          if (numVotes >= numPlayers) {
            showResults(vSnap.val());
          }
      }

      async function showResults(votesObj) {
          const votes = votesObj || {};
          const counts = {};
          Object.values(votes).forEach(id => { counts[id] = (counts[id] || 0) + 1; });
          
          let max = -1, suspectId = null;
          Object.entries(counts).forEach(([id, c]) => {
              if (c > max || (c === max && id < suspectId)) { max = c; suspectId = id; }
          });

          const players = { ...game.players };
          const imposterWasFound = suspectId === game.imposter;
          Object.keys(players).forEach(pid => {
            if (imposterWasFound && pid !== game.imposter) players[pid].score += 1;
            else if (!imposterWasFound && pid === game.imposter) players[pid].score += 2;
          });

          await db.ref(`rooms/${game.code}`).update({ phase: 'results', suspectId, players });
      }

      async function playAgain() {
        if (!game) return;
        await db.ref(`rooms/${game.code}`).update({
          phase: 'lobby', word: null, category: null, imposter: null,
          votes: null, suspectId: null, chat: null, turn: null, playerOrder: null
        });
      }

      const playersArr = Object.values(game.players || {});
      const isImposter = currentPlayer.id === game.imposter;
      const me = game.players[currentPlayer.id];
      const isHost = currentPlayer.id === game.host;

      const MainContent = () => {
        switch(game.phase) {
          case 'lobby':
            return <>
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h2 className="text-2xl font-bold">Lobby</h2>
                  <p className="text-gray-400">Venter p√• at spillere skal bli med...</p>
                </div>
                {isHost && <button className={`bg-green-500 text-white font-bold py-3 px-6 rounded-lg transition ${playersArr.length < 3 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600'}`} disabled={playersArr.length < 3} onClick={startGame}>Start Spillet</button>}
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {playersArr.map(p => <div key={p.id} className="bg-white/10 p-4 rounded-xl text-center"><div className="font-bold text-lg">{p.name} {game.host === p.id && 'üëë'}</div><div className="text-sm text-purple-300">Poeng: {p.score || 0}</div></div>)}
              </div>
            </>;
          
          case 'showWord':
            return <div className="text-center py-10">
              <h2 className="text-3xl font-bold mb-4">{isImposter ? 'Du er Imposter!' : 'Ditt hemmelige ord er:'}</h2>
              {isImposter ? 
                <div className="inline-block bg-red-500/80 px-10 py-8 rounded-2xl text-2xl font-bold shadow-lg">V√¶r lur, blend inn!</div> :
                <div className="inline-block bg-blue-500/80 px-10 py-8 rounded-2xl text-4xl font-bold shadow-lg">{game.word}</div>
              }
              <p className="text-gray-300 mt-5 text-lg">Kategori: <span className="font-semibold">{game.category === 'dyr' ? 'üêæ Dyr' : 'üîß Ting'}</span></p>
              <p className="mt-8 text-gray-400">Diskusjonen starter om noen sekunder...</p>
            </div>;
          
          case 'discussion':
            const currentTurnPlayer = game.players[game.playerOrder[game.turn]];
            const sortedMessages = Object.entries(game.chat?.messages || {}).sort((a,b) => a[1].timestamp - b[1].timestamp);

            return <>
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h2 className="text-2xl font-bold">Diskusjon</h2>
                  <p className="text-gray-400">{currentTurnPlayer?.name} sin tur til √• snakke.</p>
                </div>
                {isHost && <button className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-lg" onClick={() => db.ref(`rooms/${game.code}/phase`).set('voting')}>Start Avstemning</button>}
              </div>
              <div className="bg-black/20 h-80 rounded-lg p-4 flex flex-col space-y-3 overflow-y-auto scroll-smooth scrollbar-thin mb-4">
                {sortedMessages.map(([key, msg]) => (
                  <div key={key} className={`flex flex-col ${msg.senderId === currentPlayer.id ? 'items-end' : 'items-start'}`}>
                    <div className={`px-4 py-2 rounded-xl max-w-xs md:max-w-md ${msg.senderId === currentPlayer.id ? 'bg-purple-600 rounded-br-none' : 'bg-gray-700 rounded-bl-none'}`}>
                      {msg.senderId !== currentPlayer.id && <div className="font-bold text-xs text-purple-300 mb-1">{msg.senderName}</div>}
                      <p className="text-white">{msg.text}</p>
                    </div>
                  </div>
                ))}
                <div ref={chatEndRef} />
              </div>
              <form onSubmit={sendChatMessage} className="flex gap-3">
                <input 
                  className="flex-grow p-4 bg-black/30 border border-white/20 rounded-lg placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50"
                  placeholder={currentTurnPlayer?.id === currentPlayer.id ? "Skriv meldingen din..." : `Venter p√• ${currentTurnPlayer?.name}...`}
                  value={chatInput}
                  onChange={e => setChatInput(e.target.value)}
                  disabled={currentTurnPlayer?.id !== currentPlayer.id}
                />
                <button 
                  type="submit"
                  className="bg-purple-600 text-white font-bold py-4 px-6 rounded-lg disabled:opacity-50 hover:bg-purple-700 transition"
                  disabled={currentTurnPlayer?.id !== currentPlayer.id || !chatInput.trim()}
                >Send</button>
              </form>
            </>;
          
          case 'voting':
            const myVote = game.votes?.[currentPlayer.id];
            return <div className="py-6">
              <h2 className="text-3xl font-bold text-center mb-6">Hvem er Imposter?</h2>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                {playersArr.map(p => {
                  const votesForP = Object.values(game.votes || {}).filter(v => v === p.id).length;
                  return <button key={p.id} onClick={() => castVote(p.id)} disabled={!!myVote} className={`p-5 rounded-xl text-center transition duration-300 ${myVote ? (myVote === p.id ? 'ring-4 ring-pink-500' : 'opacity-60') : 'bg-white/10 hover:bg-white/20'}`}>
                    <div className="font-bold text-xl">{p.name}</div>
                    {votesForP > 0 && <div className="text-sm text-pink-400 mt-1">{votesForP} stemme{votesForP > 1 ? 'r' : ''}</div>}
                  </button>
                })}
              </div>
              <div className="max-w-sm mx-auto bg-black/20 p-4 rounded-lg">
                <h3 className="font-bold text-center mb-2">Stemme-status</h3>
                <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                  {playersArr.map(p => <div key={p.id} className="flex justify-between items-center text-sm"><span>{p.name}</span><span className="text-green-400">{game.votes?.[p.id] ? '‚úì' : ''}</span></div>)}
                </div>
              </div>
            </div>;
          
          case 'results':
            const imposterPlayer = game.players[game.imposter];
            const suspectPlayer = game.players[game.suspectId];
            const imposterFound = game.suspectId === game.imposter;
            return <div className="py-6 text-center">
                <h2 className="text-4xl font-extrabold mb-4">{imposterFound ? 'Imposter Funnet!' : 'Imposter R√∏mte!'}</h2>
                <div className={`p-6 rounded-xl mb-6 ${imposterFound ? 'bg-green-500/30' : 'bg-red-500/30'}`}>
                    <div>Ordet var: <strong className="font-bold text-xl">{game.word}</strong></div>
                    <div>Imposteren var: <strong className="font-bold text-xl">{imposterPlayer?.name}</strong></div>
                    <div>Flest stemmer gikk til: <strong className="font-bold text-xl">{suspectPlayer?.name || 'Ingen'}</strong></div>
                </div>
                <div className="mb-6 text-left max-w-sm mx-auto">
                    <h3 className="font-bold text-xl mb-3 text-center">Poengtavle</h3>
                    <div className="space-y-2">
                        {playersArr.slice().sort((a,b)=> b.score-a.score).map((p, i) => (
                            <div key={p.id} className="flex justify-between items-center bg-white/10 p-3 rounded-lg">
                                <span className="font-semibold">{i === 0 ? 'üëë ' : ''}{p.name}</span>
                                <span className="font-bold text-purple-300">{p.score} poeng</span>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="flex gap-4 justify-center">
                    <button className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg" onClick={playAgain}>Spill Igjen</button>
                    <button className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg" onClick={onLeave}>Forlat Rom</button>
                </div>
            </div>;
        }
        return null;
      }

      return (
        <div className="min-h-screen p-4 sm:p-6 flex flex-col">
          <div className="max-w-5xl w-full mx-auto bg-black/20 backdrop-blur-xl rounded-3xl shadow-2xl p-4 sm:p-6 flex-grow flex flex-col">
            <header className="flex justify-between items-center mb-4 border-b border-white/10 pb-4">
              <div>
                <h1 className="text-2xl font-bold">IMPOSTER</h1>
                <div className="text-sm text-gray-400">Rom: <span className="font-mono font-bold text-purple-400 tracking-widest cursor-pointer" onClick={() => navigator.clipboard.writeText(game.code)} title="Kopier kode">{game.code}</span></div>
              </div>
              <div className="flex items-center gap-4">
                <div className="text-right">
                  <div className="font-semibold">{me?.name}</div>
                  <div className="text-xs text-purple-300">Poeng: {me?.score || 0}</div>
                </div>
                <button className="px-4 py-2 bg-red-800/70 hover:bg-red-700 rounded-lg text-white font-semibold transition" onClick={onLeave}>Forlat</button>
              </div>
            </header>
            <main className="flex-grow">
              <MainContent />
            </main>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
