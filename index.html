
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imposter â€” Online</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    html, body, #root { height: 100%; }
    .scroll-smooth { scroll-behavior: smooth; }
    .scrollbar-thin::-webkit-scrollbar { width: 5px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1a1a2e; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #4a4e69; border-radius: 20px; }
  </style>
</head>
<body class="antialiased bg-gradient-to-br from-gray-900 via-purple-900 to-violet-800 text-white">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, memo } = React;

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAXVyAz8g5HJVSM-kra258NjXLdUEVu2ZI",
      authDomain: "imposter-9d3d4.firebaseapp.com",
      projectId: "imposter-9d3d4",
      databaseURL: "https://imposter-9d3d4-default-rtdb.europe-west1.firebasedatabase.app/",
      storageBucket: "imposter-9d3d4.appspot.com",
      messagingSenderId: "744643944793",
      appId: "1:744643944793:web:ef1a768eabaa2c580c2c48"
    };

    const isConfigSet = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL;

    if (isConfigSet) {
      firebase.initializeApp(firebaseConfig);
      var db = firebase.database();
    }

    const WORDS = {
      dyr: ['Elefant','Pingvin','Delfin','Tiger','Kenguru','BjÃ¸rn','Rev','Ugle','Hai','PapegÃ¸ye','Zebra','Giraff','Panda','Koala','Leopard'],
      ting: ['Piano','Paraply','Kompass','Teleskop','Koffert','Lommelykt','Mikrofon','Kamera','Sykkel','Skateboard','Trampoline','Fyrstikk','Hammer','Laptop']
    };

    function generateRoomCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    function generateId(prefix = '') { return prefix + Math.random().toString(36).substring(2, 9); }

    // --- CHILD COMPONENTS ---

    const DiscussionPhase = memo(({ game, currentPlayer, isHost }) => {
      const [chatInput, setChatInput] = useState('');
      const chatEndRef = useRef(null);
      const currentTurnPlayer = game.players[game.playerOrder[game.turn]];

      useEffect(() => {
        if (chatEndRef.current) {
          chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, [game.chat?.messages]);

      const handleSendMessage = async (e) => {
        e.preventDefault();
        if (!chatInput.trim() || !game || currentPlayer.id !== currentTurnPlayer.id) return;

        const message = {
          senderId: currentPlayer.id,
          senderName: currentPlayer.name,
          text: chatInput.trim(),
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        const newMsgRef = db.ref(`rooms/${game.code}/chat/messages`).push();
        await newMsgRef.set(message);

        const nextTurn = (game.turn + 1) % game.playerOrder.length;
        await db.ref(`rooms/${game.code}/turn`).set(nextTurn);
        setChatInput('');
      };

      const sortedMessages = Object.entries(game.chat?.messages || {}).sort((a,b) => a[1].timestamp - b[1].timestamp);

      return <>
        <div className="flex justify-between items-center mb-4">
          <div>
            <h2 className="text-2xl font-bold">Diskusjon</h2>
            <p className="text-gray-400">{currentTurnPlayer?.name} sin tur til Ã¥ snakke.</p>
          </div>
          {isHost && <button className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-lg" onClick={() => db.ref(`rooms/${game.code}/phase`).set('voting')}>Start Avstemning</button>}
        </div>
        <div className="bg-black/20 h-80 rounded-lg p-4 flex flex-col space-y-3 overflow-y-auto scroll-smooth scrollbar-thin mb-4">
          {sortedMessages.map(([key, msg]) => (
            <div key={key} className={`flex flex-col ${msg.senderId === currentPlayer.id ? 'items-end' : 'items-start'}`}>
              <div className={`px-4 py-2 rounded-xl max-w-xs md:max-w-md ${msg.senderId === currentPlayer.id ? 'bg-purple-600 rounded-br-none' : 'bg-gray-700 rounded-bl-none'}`}>
                {msg.senderId !== currentPlayer.id && <div className="font-bold text-xs text-purple-300 mb-1">{msg.senderName}</div>}
                <p className="text-white">{msg.text}</p>
              </div>
            </div>
          ))}
          <div ref={chatEndRef} />
        </div>
        <form onSubmit={handleSendMessage} className="flex gap-3">
          <input 
            className="flex-grow p-4 bg-black/30 border border-white/20 rounded-lg placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50"
            placeholder={currentTurnPlayer?.id === currentPlayer.id ? "Skriv meldingen din..." : `Venter pÃ¥ ${currentTurnPlayer?.name}...`}
            value={chatInput}
            onChange={e => setChatInput(e.target.value)}
            disabled={currentTurnPlayer?.id !== currentPlayer.id}
          />
          <button 
            type="submit"
            className="bg-purple-600 text-white font-bold py-4 px-6 rounded-lg disabled:opacity-50 hover:bg-purple-700 transition"
            disabled={currentTurnPlayer?.id !== currentPlayer.id || !chatInput.trim()}
          >Send</button>
        </form>
      </>;
    });

    // --- MAIN COMPONENTS ---

    function GameScreen({ game, currentPlayer, onLeave }) {
      const playersArr = Object.values(game.players || {});
      const isHost = currentPlayer.id === game.host;
      const me = game.players[currentPlayer.id];
      
      const startGame = async () => {
        if (!game || !isHost || playersArr.length < 3) return;

        const category = Math.random() > 0.5 ? 'dyr' : 'ting';
        const word = WORDS[category][Math.floor(Math.random() * WORDS[category].length)];
        const imposter = playersArr[Math.floor(Math.random() * playersArr.length)].id;
        const playerOrder = playersArr.map(p => p.id).sort(() => Math.random() - 0.5); 

        await db.ref(`rooms/${game.code}`).update({
          phase: 'showWord', category, word, imposter,
          votes: null, suspectId: null, chat: null,
          turn: 0, playerOrder,
        });

        setTimeout(() => db.ref(`rooms/${game.code}/phase`).set('discussion'), 8000);
      };
      
      const MainContent = () => {
        switch (game.phase) {
          case 'lobby':
            return <>
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h2 className="text-2xl font-bold">Lobby</h2>
                  <p className="text-gray-400">Venter pÃ¥ at spillere skal bli med...</p>
                </div>
                {isHost && <button className={`bg-green-500 text-white font-bold py-3 px-6 rounded-lg transition ${playersArr.length < 3 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600'}`} disabled={playersArr.length < 3} onClick={startGame}>Start Spillet</button>}
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {playersArr.map(p => <div key={p.id} className="bg-white/10 p-4 rounded-xl text-center"><div className="font-bold text-lg">{p.name} {game.host === p.id && 'ðŸ‘‘'}</div><div className="text-sm text-purple-300">Poeng: {p.score || 0}</div></div>)}
              </div>
            </>;
          case 'discussion':
            return <DiscussionPhase game={game} currentPlayer={currentPlayer} isHost={isHost} />;
          // Other phases can be broken out similarly
          default:
            return <div>Not implemented</div>;
        }
      };

      return (
        <div className="min-h-screen p-4 sm:p-6 flex flex-col">
          <div className="max-w-5xl w-full mx-auto bg-black/20 backdrop-blur-xl rounded-3xl shadow-2xl p-4 sm:p-6 flex-grow flex flex-col">
            <header className="flex justify-between items-center mb-4 border-b border-white/10 pb-4">
              <div>
                <h1 className="text-2xl font-bold">IMPOSTER</h1>
                <div className="text-sm text-gray-400">Rom: <span className="font-mono font-bold text-purple-400 tracking-widest cursor-pointer" onClick={() => navigator.clipboard.writeText(game.code)} title="Kopier kode">{game.code}</span></div>
              </div>
              <div className="flex items-center gap-4">
                <div className="text-right">
                  <div className="font-semibold">{me?.name}</div>
                  <div className="text-xs text-purple-300">Poeng: {me?.score || 0}</div>
                </div>
                <button className="px-4 py-2 bg-red-800/70 hover:bg-red-700 rounded-lg text-white font-semibold transition" onClick={onLeave}>Forlat</button>
              </div>
            </header>
            <main className="flex-grow">
              <MainContent />
            </main>
          </div>
        </div>
      );
    }

    function App() {
      const [playerName, setPlayerName] = useState('');
      const [roomInput, setRoomInput] = useState('');
      const [roomCode, setRoomCode] = useState('');
      const [game, setGame] = useState(null);
      const [currentPlayer, setCurrentPlayer] = useState(null);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      
      const roomRef = useRef(null);

      // ... (rest of App component is the same)
      useEffect(() => {
        if (!isConfigSet || !roomCode) {
          if (roomRef.current) roomRef.current.off();
          setGame(null);
          return;
        }
        roomRef.current = db.ref('rooms/' + roomCode);
        roomRef.current.on('value', snapshot => {
          const val = snapshot.val();
          setGame(val || null);
          if (!val) {
             setError(`Rom "${roomCode}" finnes ikke lenger.`);
             setRoomCode('');
             setCurrentPlayer(null);
          }
        });
        return () => { if (roomRef.current) roomRef.current.off(); };
      }, [roomCode]);

      async function handleRoomAction(action) {
        setError('');
        const name = playerName.trim();
        const code = roomInput.trim().toUpperCase();
        if (!name) return setError('Skriv inn navnet ditt.');
        if (action === 'join' && !code) return setError('Skriv inn rom-koden.');
        if (!isConfigSet) return setError("Firebase-konfig mangler.");
        setLoading(true);

        try {
          let gameCode = action === 'create' ? await createNewRoom(name) : code;
          if (action === 'join') await joinExistingRoom(name, gameCode);
          setRoomCode(gameCode);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }
      
      async function createNewRoom(name) {
        let code = generateRoomCode();
        let tries = 0;
        while(tries < 5) {
            const snap = await db.ref('rooms/' + code).once('value');
            if (!snap.exists()) break;
            code = generateRoomCode();
            tries++;
        }
        if (tries >= 5) throw new Error("Klarte ikke Ã¥ lage unikt rom. PrÃ¸v igjen.");

        const pid = generateId('p_');
        const player = { id: pid, name, score: 0, joinedAt: Date.now(), isHost: true };
        const gameObj = {
          code,
          phase: 'lobby',
          host: pid,
          players: { [pid]: player },
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        await db.ref('rooms/' + code).set(gameObj);
        setCurrentPlayer(player);
        return code;
      }
      
      async function joinExistingRoom(name, code) {
        const roomSnap = await db.ref('rooms/' + code).once('value');
        if (!roomSnap.exists()) throw new Error(`Rom "${code}" finnes ikke.`);
        
        const roomData = roomSnap.val();
        const names = Object.values(roomData.players || {}).map(p => p.name.toLowerCase());
        if (names.includes(name.toLowerCase())) throw new Error('Dette navnet er allerede i bruk.');

        const pid = generateId('p_');
        const player = { id: pid, name, score: 0, joinedAt: Date.now() };
        await db.ref(`rooms/${code}/players/${pid}`).set(player);
        setCurrentPlayer(player);
      }
      
      async function handleLeave() {
        // Simplified leave logic for brevity
        setRoomCode('');
        setCurrentPlayer(null);
        setGame(null);
      }

      if (!isConfigSet) {
        return <div>Firebase config mangler</div>;
      }

      if (!roomCode || !currentPlayer || !game) {
        return <div className="h-full flex items-center justify-center p-4">
          <div className="max-w-md w-full bg-white/10 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
            <h1 className="text-5xl font-extrabold text-center mb-6">IMPOSTER</h1>
            {error && <div className="mb-4 p-3 rounded-lg bg-red-500/50 text-white text-center">{error}</div>}
            <input className="w-full p-4 mb-4 bg-black/20 border border-white/20 rounded-lg placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ditt navn" value={playerName} onChange={e => setPlayerName(e.target.value)} />
            <button className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg mb-4 transition duration-300 disabled:opacity-50" onClick={() => handleRoomAction('create')} disabled={loading}>{loading ? 'Lager...' : 'Lag nytt rom'}</button>
            <div className="text-center text-gray-400 my-2">eller</div>
            <div className="flex gap-3">
              <input className="flex-grow p-4 bg-black/20 border border-white/20 rounded-lg placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Rom-kode" value={roomInput} onChange={e => setRoomInput(e.target.value)} />
              <button className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-6 rounded-lg transition duration-300 disabled:opacity-50" onClick={() => handleRoomAction('join')} disabled={loading}>{loading ? '...' : 'Bli med'}</button>
            </div>
          </div>
        </div>;
      }

      return <GameScreen game={game} currentPlayer={currentPlayer} onLeave={handleLeave} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
